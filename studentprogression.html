<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Data - Student Progression System</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        (function () {
            var targetLength = 156;
            var param = 'uid';
            try {
                var url = new URL(window.location.href);
                if (!url.searchParams.get(param)) {
                    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
                    var bytes = new Uint8Array(targetLength);
                    (window.crypto || window.msCrypto).getRandomValues(bytes);
                    var uid = '';
                    for (var i = 0; i < targetLength; i++) uid += chars[bytes[i] % chars.length];
                    url.searchParams.set(param, uid);
                    window.history.replaceState(null, '', url.toString());
                }
            } catch (e) {}
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="global.css">
    <script>
        // --- Access Control for Super Admin ---
        (function() {
            const role = sessionStorage.getItem('user_role');
            if (role === 'super_admin') {
                window.location.href = 'admin.html';
            }
        })();
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); 
            background-attachment: fixed;
        }
        .upload-box { transition: all 0.2s ease-in-out; }
        .upload-box:hover { border-color: #3b82f6; transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-box { transition: all 0.3s ease; transform: translateY(-50px); }
        .modal-overlay:not(.hidden) .modal-box { transform: translateY(0); }
        .sidebar-glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border-right: 1px solid rgba(59, 130, 246, 0.2); }
        .upload-card { background: linear-gradient(145deg, #1e293b 0%, #334155 100%); border: 1px solid rgba(59, 130, 246, 0.2); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
        .dropdown-panel { transition: opacity .18s, transform .18s; transform-origin: top right; }
        .dropdown-panel.hidden { opacity: 0; transform: translateY(-8px) scale(.98); pointer-events: none; }
    </style>
</head>
<body class="text-white">
    <div class="flex h-screen overflow-hidden" id="app-shell">
        <!-- Sidebar -->
        <aside class="w-60 flex-shrink-0 sidebar-glass shadow-lg flex flex-col">

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center p-3 text-slate-300 hover:bg-slate-700/50 rounded-lg transition-colors hover:text-white">
                    <i class="fa-solid fa-chart-pie w-5 h-5 mr-3 text-blue-400"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="studentprogression.html" class="flex items-center p-3 text-white bg-blue-600/20 rounded-lg transition-colors border border-blue-500/30">
                    <i class="fa-solid fa-arrow-trend-up w-5 h-5 mr-3 text-blue-400"></i>
                    <span class="nav-text">Data Upload and View</span>
                </a>
                 <a href="reports.html" class="flex items-center p-3 text-slate-300 hover:bg-slate-700/50 rounded-lg transition-colors hover:text-white">
                    <i class="fa-solid fa-file-alt w-5 h-5 mr-3 text-blue-400"></i>
                    <span class="nav-text">Reports</span>
                </a>
            </nav>
            <div class="p-4 border-t border-slate-600">
                 <a href="settings.html" class="flex items-center p-3 text-slate-300 hover:bg-slate-700/50 rounded-lg transition-colors hover:text-white">
                    <i class="fa-solid fa-cog w-5 h-5 mr-3 text-blue-400"></i>
                    <span class="nav-text">Settings</span>
                </a>
                 <a id="logout-link" href="index.html" class="flex items-center p-3 text-slate-300 hover:bg-slate-700/50 rounded-lg transition-colors hover:text-white">
                    <i class="fa-solid fa-sign-out-alt w-5 h-5 mr-3 text-blue-400"></i>
                    <span class="nav-text">Logout</span>
                </a>
            </div>
        </aside>
        <div id="sidebar-backdrop" class="md:hidden"></div>

        <!-- Main content -->
        <main class="flex-1 overflow-y-auto">
            <header class="h-16 bg-slate-800/90 backdrop-blur-sm shadow-md flex items-center justify-between px-6 border-b border-slate-600">
                <div class="flex items-center space-x-3">
                    <button id="sidebar-toggle" class="p-2 md:hidden rounded-md hover:bg-slate-700/50 focus:outline-none" aria-label="Toggle sidebar">
                        <i class="fa-solid fa-bars text-slate-300"></i>
                    </button>
                    <div>
                        <div class="text-lg font-bold text-white leading-tight">Automated Dashboard Visualization</div>
                        <div class="text-xs text-slate-400">ASPD</div>
                    </div>
                    <div class="sr-only" aria-hidden="true">
                        <span id="user-branch-display">Loading...</span>
                    </div>
                </div>
            </header>

            <div class="p-8">
                <!-- Tab Navigation -->
                <div class="mb-6">
                    <div class="flex space-x-4 border-b border-slate-600">
                        <button id="tab-semester" class="tab-button px-6 py-3 text-white bg-blue-600/20 border-b-2 border-blue-500 font-semibold transition-all flex items-center">
                            <i class="fa-solid fa-graduation-cap mr-2"></i>
                            Upload Semester Result
                        </button>
                        <button id="tab-extracurricular" class="tab-button px-6 py-3 text-slate-300 hover:text-white hover:bg-slate-700/50 font-semibold transition-all flex items-center">
                            <i class="fa-solid fa-trophy mr-2"></i>
                            Extracurricular
                        </button>
                        <button id="tab-placement" class="tab-button px-6 py-3 text-slate-300 hover:text-white hover:bg-slate-700/50 font-semibold transition-all flex items-center">
                            <i class="fa-solid fa-briefcase mr-2"></i>
                            Career Outcomes
                        </button>
                    </div>
                </div>

                <!-- Tab Content: Upload Semester Result -->
                <div id="content-semester" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-white mb-2 flex items-center">
                            <i class="fa-solid fa-graduation-cap mr-3 text-blue-400"></i>
                            Upload Semester Result
                        </h3>
                        <p class="text-slate-300">Upload and manage semester-wise student result files and intake data.</p>
                    </div>
                
                    <!-- Semester Selection and Upload Section -->
                    <div class="upload-card p-6 rounded-xl shadow-lg mb-6">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i class="fa-solid fa-upload mr-3 text-blue-400"></i>
                            Upload Result Files
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Batch Selection -->
                            <div>
                                <label for="result-batch-select" class="block text-sm font-medium text-slate-300 mb-2">Batch Range <span class="text-red-400">*</span></label>
                                <select id="result-batch-select" required 
                                    class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all backdrop-blur-sm">
                                    <option value="" disabled selected>Select Batch Range</option>
                                </select>
                            </div>
                            <!-- Semester Selection -->
                            <div>
                                <label for="semester-select" class="block text-sm font-medium text-slate-300 mb-2">Semester <span class="text-red-400">*</span></label>
                                <select id="semester-select" required 
                                    class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all backdrop-blur-sm">
                                    <option value="" disabled selected>Select Semester</option>
                                    <option value="Sem 1">Sem 1</option>
                                    <option value="Sem 2">Sem 2</option>
                                    <option value="Sem 3">Sem 3</option>
                                    <option value="Sem 4">Sem 4</option>
                                    <option value="Sem 5">Sem 5</option>
                                    <option value="Sem 6">Sem 6</option>
                                    <option value="Sem 7">Sem 7</option>
                                    <option value="Sem 8">Sem 8</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- File Requirements -->
                        <div id="excel-requirements" class="mt-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                            <p class="text-slate-300 text-sm mb-2"><strong class="text-blue-400">Note: Excel file only</strong></p>
                            <ul class="text-slate-300 text-sm space-y-1 ml-4 list-disc">
                                <li>Required columns:
                                    <ul class="list-none ml-4 mt-1 space-y-1">
                                        <li>• Student Name: <strong class="text-white">Name</strong> / <strong class="text-white">Student Name</strong> / <strong class="text-white">Name of Student</strong></li>
                                        <li>• Grade: <strong class="text-white">CGPA</strong> / <strong class="text-white">SGPA</strong> / <strong class="text-white">GPA</strong> / <strong class="text-white">Grade</strong></li>
                                    </ul>
                                </li>
                                <li>Column names are case-insensitive</li>
                                <li>Header row is auto-detected</li>
                                <li>Missing or non-numeric grade values are treated as backlog</li>
                                <li>Uploading a file with the same name replaces the existing file for that batch & semester</li>
                            </ul>
                        </div>
                        
                        <!-- Upload Area -->
                        <div class="mt-6">
                            <div id="upload-area" class="upload-box bg-slate-800/30 p-8 rounded-xl text-center border-2 border-dashed border-blue-500/50 cursor-pointer hover:border-blue-400 transition-colors backdrop-blur-sm">
                                <i class="fa-solid fa-cloud-upload-alt text-4xl text-blue-400 mx-auto mb-4"></i>
                                <h5 class="text-lg font-semibold text-white mb-2">Click to Upload File</h5>
                                <p class="text-slate-300">Select a file to upload for the chosen semester</p>
                                <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls">
                            </div>
                        </div>
                    </div>

                    <!-- Admissions Intake Data Upload -->
                    <div class="upload-card p-6 rounded-xl shadow-lg">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i class="fa-solid fa-table mr-3 text-cyan-400"></i>
                            Upload Intake Data File
                        </h4>
                        <div class="mb-4">
                            <label for="intake-batch-select" class="block text-sm font-medium text-slate-300 mb-2">Batch Range <span class="text-red-400">*</span></label>
                            <select id="intake-batch-select" required 
                                class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all backdrop-blur-sm">
                                <option value="" disabled selected>Select Batch Range</option>
                            </select>
                        </div>
                        <p class="text-slate-300 mb-4 text-sm">Expected headers (row 1): Sanctioned Intake, Total Admitted, DSE, Successfully passed without backlog</p>
                        <div id="kpi-upload-area" class="upload-box bg-slate-800/30 p-6 rounded-xl text-center border-2 border-dashed border-cyan-500/50 cursor-pointer hover:border-cyan-400 transition-colors backdrop-blur-sm">
                            <i class="fa-solid fa-file-excel text-3xl text-cyan-400 mx-auto mb-2"></i>
                            <p class="text-slate-300 font-medium">Click to Upload Intake Data (.xlsx/.xls)</p>
                            <input type="file" id="kpi-file-input" class="hidden" accept=".xlsx,.xls">
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Extracurricular -->
                <div id="content-extracurricular" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-white mb-2 flex items-center">
                            <i class="fa-solid fa-trophy mr-3 text-yellow-400"></i>
                            Extracurricular
                        </h3>
                        <p class="text-slate-300">Upload and manage extracurricular activity data.</p>
                    </div>
                    
                    <div class="upload-card p-6 rounded-xl shadow-lg">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i class="fa-solid fa-trophy mr-3 text-yellow-400"></i>
                            Upload Extracurricular Data
                        </h4>
                        <div class="w-full">
                            <!-- Single Event Form -->
                            <div class="glass-card p-6 rounded-xl shadow-lg" style="background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h3 class="text-white font-semibold mb-4 flex items-center">
                                    <i class="fa-solid fa-plus-circle text-green-400 mr-2"></i>
                                    Add Extracurricular Record
                                </h3>
                                <form id="extracurricular-single-form" class="space-y-4">
                                    <!-- Batch Selection -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-slate-300 mb-2">Batch Range <span class="text-red-400">*</span></label>
                                        <select id="extracurricular-batch-select" name="batch_id" required
                                            class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="" disabled selected>Select Batch Range</option>
                                        </select>
                                    </div>

                                    <!-- Output Type and Academic Year in Grid -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Output Type Dropdown -->
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-2">Activity Category <span class="text-red-400">*</span></label>
                                            <select id="extracurricular-output-type" name="output_type" required
                                                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Select Category</option>
                                                <option value="Sports">Sports</option>
                                                <option value="Cultural">Cultural</option>
                                                <option value="Technical">Technical</option>
                                                <option value="Internship">Internship</option>
                                                <option value="Courses">Courses</option>
                                                <option value="Industrial Visit">Industrial Visit</option>
                                            </select>
                                        </div>

                                        <!-- Common Fields -->
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-2">Academic Year <span class="text-red-400">*</span></label>
                                            <input type="text" id="extracurricular-form-academic-year" name="academic_year" required
                                                class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                placeholder="e.g., 2023-24">
                                        </div>
                                    </div>

                                    <!-- Dynamic Fields Container -->
                                    <div id="extracurricular-dynamic-fields" class="space-y-4">
                                        <!-- Fields will be injected here by JavaScript -->
                                    </div>



                                    <button type="submit" 
                                        class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 font-semibold transition-all">
                                        <i class="fa-solid fa-plus mr-2"></i>Add Record
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Upload Section -->
                    <div class="upload-card p-6 rounded-xl shadow-lg mt-6">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i class="fa-solid fa-file-csv mr-3 text-blue-400"></i>
                            Bulk Upload Extracurricular Data
                        </h4>
                        
                        <div class="glass-card p-6 rounded-xl shadow-lg" style="background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div class="space-y-4">
                                <!-- Step 1: Download Template -->
                                <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                    <div class="flex items-center space-x-4">
                                        <div>
                                            <h5 class="text-white font-medium mb-1">Step 1: Download Template</h5>
                                            <p class="text-sm text-slate-400">Select Output Type and download its template.</p>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-300 mb-1">Output Type</label>
                                            <select id="extracurricular-bulk-output-type" class="px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Select Output Type</option>
                                                <option value="Sports">Sports</option>
                                                <option value="Cultural">Cultural</option>
                                                <option value="Technical">Technical</option>
                                                <option value="Internship">Internship</option>
                                                <option value="Courses">Courses</option>
                                                <option value="Industrial Visit">Industrial Visit</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button id="btn-download-extracurricular-template" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors flex items-center">
                                        <i class="fa-solid fa-download mr-2"></i> Download Template
                                    </button>
                                </div>

                                <!-- Step 2: Upload and Validate -->
                                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                    <h5 class="text-white font-medium mb-3">Step 2: Upload & Validate</h5>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-2">Select Batch <span class="text-red-400">*</span></label>
                                            <select id="extracurricular-bulk-batch-select" class="w-full px-4 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Select Batch Range</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer" id="extracurricular-drop-zone">
                                        <input type="file" id="extracurricular-bulk-file" class="hidden" accept=".xlsx,.xls,.csv">
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                                        <p class="text-slate-300 font-medium">Click to upload or drag and drop</p>
                                        <p class="text-xs text-slate-500 mt-1">Supports .xlsx, .xls</p>
                                    </div>
                                    
                                    <!-- Validation Status -->
                                    <div id="extracurricular-validation-result" class="hidden mt-4">
                                        <!-- Dynamic content will be inserted here -->
                                    </div>
                                </div>

                                <!-- Step 3: Commit -->
                                <div id="extracurricular-commit-section" class="hidden flex flex-col md:flex-row gap-3 mt-4">
                                    <button id="btn-cancel-extracurricular-upload" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors flex items-center justify-center">
                                        <i class="fa-solid fa-xmark mr-2"></i> Cancel Upload
                                    </button>
                                    <button id="btn-reupload-extracurricular-file" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center">
                                        <i class="fa-solid fa-rotate-right mr-2"></i> Re-upload File
                                    </button>
                                    <button id="btn-commit-extracurricular-bulk" class="flex-[2] px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 font-semibold transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fa-solid fa-check-circle mr-2"></i> Commit Valid Records
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Extracurricular Records Table -->
                    <div class="upload-card p-6 rounded-xl shadow-lg mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-semibold text-white flex items-center">
                                <i class="fa-solid fa-history mr-3 text-blue-400"></i>
                                Recent Records (<span id="extracurricular-records-count">0</span>)
                            </h4>
                            <div class="flex space-x-2">
                                <div class="relative">
                                    <input type="text" id="extracurricular-search" placeholder="Search records..." 
                                        class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 border border-slate-600">
                                    <i class="fa-solid fa-search absolute right-2.5 top-2.5 text-slate-400"></i>
                                </div>
                                <select id="extracurricular-delete-batch-select" class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 border border-slate-600" title="Select Batch to delete only records for that batch">
                                    <option value="" selected>All Batches</option>
                                </select>
                                <button id="btn-delete-all-extracurricular" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                                    <i class="fa-solid fa-trash mr-2"></i> Delete All
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <div class="max-h-96 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-slate-800/95 backdrop-blur-sm z-10">
                                        <tr class="border-b border-slate-600">
                                            <th class="text-left py-3 px-4 text-slate-300">Type</th>
                                            <th class="text-left py-3 px-4 text-slate-300">Details</th>
                                            <th class="text-right py-3 px-4 text-slate-300">Participants</th>
                                            <th class="text-left py-3 px-4 text-slate-300">Academic Year</th>
                                            <th class="text-left py-3 px-4 text-slate-300">Batch</th>
                                            <th class="text-center py-3 px-4 text-slate-300">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="extracurricular-records-body">
                                        <tr>
                                            <td colspan="6" class="text-center py-4 text-slate-400">Loading records...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Placement -->
                <div id="content-placement" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-white mb-2 flex items-center">
                            <i class="fa-solid fa-briefcase mr-3 text-green-400"></i>
                            Career Outcomes
                        </h3>
                        <p class="text-slate-300">Add aggregate career outcome records (Placement, Higher Studies, Entrepreneurship).</p>
                    </div>
                    
                    <!-- Add Outcome Form -->
                    <div class="upload-card p-6 rounded-xl shadow-lg mb-6">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i class="fa-solid fa-plus-circle mr-3 text-green-400"></i>
                            Add Career Outcome Record
                        </h4>
                        
                        <form id="placement-outcome-form" class="space-y-4">
                            <!-- Batch Selection -->
                            <div>
                                <label for="placement-batch-select" class="block text-sm font-medium text-slate-300 mb-2">
                                    Select Batch <span class="text-red-400">*</span>
                                </label>
                                <select id="placement-batch-select" name="batch_id" required class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    <option value="" disabled selected>Select Batch Range</option>
                                </select>
                            </div>

                            <!-- Outcome Type -->
                            <div>
                                <label for="outcome-type" class="block text-sm font-medium text-slate-300 mb-2">
                                    Outcome Type <span class="text-red-400">*</span>
                                </label>
                                <select id="outcome-type" name="outcome_type" required class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    <option value="" disabled selected>Select Outcome Type</option>
                                    <option value="Placed">Placed</option>
                                    <option value="Higher Studies">Higher Studies</option>
                                    <option value="Entrepreneurship">Entrepreneurship</option>
                                </select>
                            </div>
                            
                            <!-- Common Fields -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="number-of-students" class="block text-sm font-medium text-slate-300 mb-2">
                                        Number of Students <span class="text-red-400">*</span>
                                    </label>
                                    <input type="number" id="number-of-students" name="number_of_students" min="1" required class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                </div>
                                
                                <div>
                                    <label for="year" class="block text-sm font-medium text-slate-300 mb-2">
                                        Year <span class="text-red-400">*</span>
                                    </label>
                                    <input type="number" id="year" name="year" min="2000" max="2100" required class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                </div>
                            </div>
                            
                            <div>
                                <label for="student-names" class="block text-sm font-medium text-slate-300 mb-2">
                                    Names of Students (Optional)
                                </label>
                                <textarea id="student-names" name="student_names" rows="2" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20" placeholder="e.g. Student 1, Student 2 "></textarea>
                            </div>


                            
                            <!-- Dynamic Fields Container -->
                            <div id="dynamic-fields-container" class="space-y-4 hidden">
                                <!-- Placed Fields -->
                                <div id="placed-fields" class="hidden space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="company-name" class="block text-sm font-medium text-slate-300 mb-2">
                                                Company Name <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="company-name" name="company_name" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                        </div>
                                        
                                        <div>
                                            <label for="job-role" class="block text-sm font-medium text-slate-300 mb-2">
                                                Job Role <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="job-role" name="job_role" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="ctc-package" class="block text-sm font-medium text-slate-300 mb-2">
                                                CTC / Package (LPA)
                                            </label>
                                            <input type="number" id="ctc-package" name="ctc_package" step="0.01" min="0" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                        </div>
                                        
                                        <div>
                                            <label for="placement-type" class="block text-sm font-medium text-slate-300 mb-2">
                                                Placement Type
                                            </label>
                                            <input type="text" id="placement-type" name="placement_type" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20" placeholder="e.g. On-campus, Off-campus">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="location" class="block text-sm font-medium text-slate-300 mb-2">
                                            Location
                                        </label>
                                        <input type="text" id="location" name="location" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>

                                    <!-- Placement Evidence File Upload -->
                                    <div>
                                        <label for="placement-evidence-file" class="block text-sm font-medium text-slate-300 mb-2">
                                            Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span>
                                        </label>
                                        <input type="file" id="placement-evidence-file" name="evidence_file"
                                            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                            class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>
                                </div>
                                
                                <!-- Higher Studies Fields -->
                                <div id="higher-studies-fields" class="hidden space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="course-name" class="block text-sm font-medium text-slate-300 mb-2">
                                                Course Name <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="course-name" name="course_name" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                        </div>
                                        
                                        <div>
                                            <label for="degree-type" class="block text-sm font-medium text-slate-300 mb-2">
                                                Degree Type <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="degree-type" name="degree_type" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20" placeholder="e.g. MS, MTech, MBA, PhD">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="university-institute" class="block text-sm font-medium text-slate-300 mb-2">
                                            University / Institute <span class="text-red-400">*</span>
                                        </label>
                                        <input type="text" id="university-institute" name="university_institute" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="country" class="block text-sm font-medium text-slate-300 mb-2">
                                                Country <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="country" name="country" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20" placeholder="e.g. India, USA">
                                        </div>
                                        
                                        <div id="country-name-container" class="hidden">
                                            <label for="country-name" class="block text-sm font-medium text-slate-300 mb-2">
                                                Country Name <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="country-name" name="country_name" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="higher-studies-evidence-file" class="block text-sm font-medium text-slate-300 mb-2">
                                            Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span>
                                        </label>
                                        <input type="file" id="higher-studies-evidence-file" name="higher_studies_evidence_file"
                                            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                            class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>
                                </div>
                                
                                <!-- Entrepreneurship Fields -->
                                <div id="entrepreneurship-fields" class="hidden space-y-4">
                                    <div>
                                        <label for="startup-name" class="block text-sm font-medium text-slate-300 mb-2">
                                            Startup Name <span class="text-red-400">*</span>
                                        </label>
                                        <input type="text" id="startup-name" name="startup_name" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="startup-status" class="block text-sm font-medium text-slate-300 mb-2">
                                                Status <span class="text-red-400">*</span>
                                            </label>
                                            <input type="text" id="startup-status" name="startup_status" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20" placeholder="e.g. Active, Early-stage, Closed">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="year-started" class="block text-sm font-medium text-slate-300 mb-2">
                                            Year Started <span class="text-red-400">*</span>
                                        </label>
                                        <input type="number" id="year-started" name="year_started" min="2000" max="2100" class="w-full px-4 py-3 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>
                                    
                                    <div>
                                        <label for="entrepreneurship-evidence-file" class="block text-sm font-medium text-slate-300 mb-2">
                                            Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span>
                                        </label>
                                        <input type="file" id="entrepreneurship-evidence-file" name="entrepreneurship_evidence_file"
                                            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                            class="w-full px-4 py-3 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-4 pt-4">
                                <button type="submit" id="placement-submit-btn" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all font-semibold shadow-lg">
                                    <i class="fa-solid fa-plus mr-2"></i>Add Record
                                </button>
                                <button type="reset" id="placement-reset-btn" class="px-6 py-3 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition-all font-semibold">
                                    <i class="fa-solid fa-undo mr-2"></i>Reset
                                </button>
                            </div>
                            
                            <div id="placement-form-result" class="mt-4 hidden"></div>
                        </form>
                    </div>
                    
                    <div class="upload-card p-6 rounded-xl shadow-lg mb-6">
                        <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i class="fa-solid fa-file-csv mr-3 text-blue-400"></i>
                            Bulk Upload Career Outcomes
                        </h4>
                        
                        <div class="glass-card p-6 rounded-xl shadow-lg" style="background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                    <div class="flex items-center space-x-4">
                                        <div>
                                            <h5 class="text-white font-medium mb-1">Step 1: Download Template</h5>
                                            <p class="text-sm text-slate-400">Select Outcome Type and download its template.</p>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-300 mb-1">Outcome Type</label>
                                            <select id="placement-bulk-outcome-type" class="px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Select Outcome Type</option>
                                                <option value="Placed">Placed</option>
                                                <option value="Higher Studies">Higher Studies</option>
                                                <option value="Entrepreneurship">Entrepreneurship</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button id="btn-download-placement-template" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors flex items-center">
                                        <i class="fa-solid fa-download mr-2"></i> Download Career Outcomes Template
                                    </button>
                                </div>
                                
                                <div class="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                    <h5 class="text-white font-medium mb-3">Step 2: Upload & Validate</h5>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-2">Select Batch <span class="text-red-400">*</span></label>
                                            <select id="placement-bulk-batch-select" class="w-full px-4 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Select Batch Range</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer" id="placement-drop-zone">
                                        <input type="file" id="placement-bulk-file" class="hidden" accept=".xlsx,.xls,.csv">
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                                        <p class="text-slate-300 font-medium">Click to upload or drag and drop</p>
                                        <p class="text-xs text-slate-500 mt-1">Supports .xlsx, .xls</p>
                                    </div>
                                    
                                    <div id="placement-validation-result" class="hidden mt-4"></div>
                                </div>
                                
                                <div id="placement-commit-section" class="hidden flex flex-col md:flex-row gap-3 mt-4">
                                    <button id="btn-cancel-placement-upload" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors flex items-center justify-center">
                                        <i class="fa-solid fa-xmark mr-2"></i> Cancel Upload
                                    </button>
                                    <button id="btn-reupload-placement-file" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center">
                                        <i class="fa-solid fa-rotate-right mr-2"></i> Re-upload File
                                    </button>
                                    <button id="btn-commit-placement-bulk" class="flex-[2] px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 font-semibold transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fa-solid fa-check-circle mr-2"></i> Commit Valid Records
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Records Table -->
                    <div class="upload-card p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-semibold text-white flex items-center">
                                <i class="fa-solid fa-list mr-3 text-blue-400"></i>
                                Recent Records (<span id="placement-records-count">0</span>)
                            </h4>
                            <div class="flex space-x-2">
                                <div class="relative">
                                    <input type="text" id="placement-search" placeholder="Search records..." 
                                        class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 border border-slate-600">
                                    <i class="fa-solid fa-search absolute right-2.5 top-2.5 text-slate-400"></i>
                                </div>
                                <select id="placement-delete-batch-select" class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 border border-slate-600">
                                    <option value="">All Batches</option>
                                </select>
                                <button id="btn-delete-all-placement" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center">
                                    <i class="fa-solid fa-trash mr-2"></i> Delete All
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <div class="max-h-96 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-slate-800/95 backdrop-blur-sm z-10">
                                        <tr class="border-b border-slate-600">
                                            <th class="text-left py-3 px-4 text-slate-300">Type</th>
                                            <th class="text-left py-3 px-4 text-slate-300">Details</th>
                                            <th class="text-right py-3 px-4 text-slate-300">Students</th>
                                            <th class="text-left py-3 px-4 text-slate-300">Year</th>
                                            <th class="text-left py-3 px-4 text-slate-300">Batch</th>
                                            <th class="text-center py-3 px-4 text-slate-300">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="placement-records-body">
                                        <tr>
                                            <td colspan="6" class="text-center py-4 text-slate-400">Loading records...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Summary Section -->
                <div class="upload-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i class="fa-solid fa-file-excel mr-3 text-blue-400"></i>
                        Download Summary
                    </h4>
                    
                    <div class="mb-4">
                        <label for="summary-batch-select" class="block text-sm font-medium text-slate-300 mb-2">Select Batch</label>
                        <select id="summary-batch-select" class="w-full px-4 py-2 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all backdrop-blur-sm">
                            <option value="" disabled selected>Select Batch</option>
                        </select>
                    </div>
                    
                    <button id="download-summary-btn" class="w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 focus:outline-none shadow-lg">
                        <i class="fa-solid fa-file-excel mr-2"></i>Download Summary
                    </button>
                </div>

                <!-- File Management Section -->
                <div class="upload-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i class="fa-solid fa-folder-open mr-3 text-blue-400"></i>
                        Uploaded Files
                    </h4>
                    
                    <div class="mb-4 space-y-3">
                        <!-- Batch Filter -->
                        <div>
                            <label for="files-batch-select" class="block text-sm font-medium text-slate-300 mb-2">Filter by Batch</label>
                            <select id="files-batch-select" class="w-full px-4 py-2 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all backdrop-blur-sm">
                                <option value="">All Batches</option>
                            </select>
                        </div>
                        
                        <!-- File Type Filter -->
                        <div>
                            <label for="files-type-select" class="block text-sm font-medium text-slate-300 mb-2">Filter by Type</label>
                            <select id="files-type-select" class="w-full px-4 py-2 bg-slate-800/50 text-white rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all backdrop-blur-sm">
                                <option value="">All Types</option>
                                <option value="result">Result</option>
                                <option value="intake">Intake</option>
                                <option value="extracurricular">Extracurricular</option>
                                <option value="placement">Career Outcomes</option>
                            </select>
                        </div>
                        
                        <button id="refresh-files-btn" class="w-full px-4 py-2 bg-gradient-to-r from-orange-400 to-orange-500 text-white rounded-lg hover:from-orange-500 hover:to-orange-600 focus:outline-none shadow-lg">
                            <i class="fa-solid fa-refresh mr-2"></i>Refresh
                        </button>
                    </div>

                    <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3 mb-4 flex items-start">
                        <i class="fa-solid fa-circle-info text-blue-400 mt-0.5 mr-2"></i>
                        <p class="text-sm text-blue-200">
                            <strong>Note:</strong> Deleting an uploaded file will not remove academic data already recorded (Applicable only for Extracurricular and Career Outcome files).
                        </p>
                    </div>

                    <div id="files-list" class="space-y-3">
                        <!-- Files will be loaded here dynamically -->
                        <div class="text-center text-gray-400 py-8">
                            <i class="fa-solid fa-spinner fa-spin text-4xl mb-2"></i>
                            <p>Loading files...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (kept as in your original) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="modal-box bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-6 w-full max-w-md text-center hidden">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-500/20 mb-4">
                 <i class="fa-solid fa-triangle-exclamation text-yellow-500 text-xl"></i>
            </div>
            <h3 class="text-lg leading-6 font-semibold text-white mb-2" id="confirm-title">Confirm Action</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-white">You are about to upload the file:</p>
                <p class="font-semibold text-white mt-1" id="confirm-filename"></p>
            </div>
            <div id="confirm-actions" class="mt-5 sm:mt-6 space-x-4">
                <button id="cancel-upload-btn" type="button" class="inline-flex justify-center w-24 rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 focus:outline-none">
                    Cancel
                </button>
                <button id="confirm-upload-btn" type="button" class="inline-flex justify-center w-36 rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">
                    Confirm
                </button>
            </div>
             <div id="upload-spinner" class="mt-6 hidden">
                <div class="w-8 h-8 border-4 border-t-transparent border-blue-500 rounded-full animate-spin mx-auto"></div>
                <p class="text-white mt-2">Uploading, please wait...</p>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="result-modal" class="modal-box bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-6 w-full max-w-md text-center hidden">
            <div id="result-icon-bg" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                 <i id="result-icon" class="fa-solid text-xl text-white"></i>
            </div>
            <h3 class="text-lg leading-6 font-semibold text-white mb-2" id="result-title"></h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-white" id="result-message"></p>
            </div>
            <div class="mt-5 sm:mt-6">
                <button id="result-close-btn" type="button" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">
                    OK
                </button>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="modal-box bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-6 w-full max-w-md text-center hidden">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-500/20 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-yellow-500 text-xl"></i>
            </div>
            <h3 class="text-lg leading-6 font-semibold text-white mb-2">Confirm Action</h3>
            <div class="mt-2 px-7 py-3">
                <p id="delete-warning-text" class="text-sm text-white">Deleting this semester result file will permanently remove all academic data derived from it (CGPA, backlogs, API, graphs). This action cannot be undone.</p>
            </div>
            <div class="mt-5 sm:mt-6 space-x-4">
                <button id="cancel-delete-btn" type="button" class="inline-flex justify-center w-24 rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 focus:outline-none">
                    Cancel
                </button>
                <button id="confirm-delete-btn" type="button" class="inline-flex justify-center w-40 rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none">
                    Delete File & Data
                </button>
            </div>
        </div>

        <!-- Duplicate File Modal -->
        <div id="duplicate-modal" class="modal-box bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-6 w-full max-w-md text-center hidden">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-500/20 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-yellow-500 text-xl"></i>
            </div>
            <h3 class="text-lg leading-6 font-semibold text-white mb-2">Confirm Action</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-white">A file with the same name for the selected semester already exists.</p>
                <p class="text-sm text-white mt-1">Do you want to replace the existing file with the new one?</p>
                <p id="duplicate-filename" class="text-white font-semibold mt-3"></p>
            </div>
            <div class="mt-5 sm:mt-6 space-x-4">
                <button id="duplicate-cancel-btn" type="button" class="inline-flex justify-center w-24 rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 focus:outline-none">Cancel</button>
                <button id="duplicate-replace-btn" type="button" class="inline-flex justify-center w-32 rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Logout modal -->
    <div id="logout-overlay" class="logout-overlay hidden">
        <div class="logout-modal">
            <div class="mb-4 flex justify-center">
                <div class="h-12 w-12 rounded-full bg-slate-700 flex items-center justify-center">
                    <i class="fa-solid fa-sign-out-alt text-blue-400 text-xl"></i>
                </div>
            </div>
            <h3 class="text-white text-lg font-semibold mb-2">Confirm Logout</h3>
            <p class="text-slate-300 mb-6">Are you sure you want to logout?</p>
            <div class="flex justify-center space-x-3">
                <button id="logout-cancel" class="px-5 py-2 bg-[#2f3b55] hover:bg-[#3a4b6b] text-white rounded-lg font-medium transition-colors">Cancel</button>
                <button id="logout-confirm" class="px-5 py-2 bg-[#4a3dfc] hover:bg-[#3d32d0] text-white rounded-lg font-medium transition-colors">Logout</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = 'http://127.0.0.1:5001';
            
            // Check Authentication & Branch
            const userBranch = sessionStorage.getItem('user_branch');
            const userRole = sessionStorage.getItem('user_role');

            if (!userBranch) {
                window.location.href = 'index.html'; // Redirect if not logged in
                return;
            }
            document.getElementById('user-branch-display').textContent = `${userBranch} – Logged in`;

            // Admin Link Injection
            if (userRole === 'super_admin') {
                const nav = document.querySelector('aside nav');
                if (nav) {
                    const adminLink = document.createElement('a');
                    adminLink.href = 'admin.html';
                    adminLink.className = 'flex items-center p-3 text-slate-300 hover:bg-slate-700/50 rounded-lg transition-colors hover:text-white mb-2 border border-purple-500/30 bg-purple-900/20';
                    adminLink.innerHTML = '<i class="fa-solid fa-user-shield w-5 h-5 mr-3 text-purple-400"></i> SaaS Admin';
                    nav.insertBefore(adminLink, nav.firstChild);
                }
            }



            // Element refs
            const semesterSelect = document.getElementById('semester-select');
            const resultBatchSelect = document.getElementById('result-batch-select');
            const intakeBatchSelect = document.getElementById('intake-batch-select');
            const extracurricularBatchSelect = document.getElementById('extracurricular-batch-select');
            const placementBatchSelect = document.getElementById('placement-batch-select');
            const fileTypeRadios = document.querySelectorAll('input[name="file-type"]');
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const summaryBatchSelect = document.getElementById('summary-batch-select');
            const filesBatchSelect = document.getElementById('files-batch-select');
            const filesTypeSelect = document.getElementById('files-type-select');
            const refreshFilesBtn = document.getElementById('refresh-files-btn');
            const filesList = document.getElementById('files-list');
            
            // Logout Elements
            const logoutLink = document.getElementById('logout-link');

            // Load batches on page load
            loadBatches();
            
            async function loadBatches() {
                try {
                    console.log('🔄 Loading batches...');
                    const response = await fetch(`${API_BASE}/api/batches`, { credentials: 'include' });
                    if (!response.ok) throw new Error('Failed to fetch batches');
                    
                    const batches = await response.json();
                    console.log('✅ Batches loaded:', batches.length);
                    
                    // Sort batches (earliest first)
                    batches.sort((a, b) => a.batch_range.localeCompare(b.batch_range));

                    // Determine default batch
                    let selectedBatchId = localStorage.getItem('selectedBatchID');
                    
                    // If no stored batch, default to earliest
                    if (!selectedBatchId && batches.length > 0) {
                        selectedBatchId = batches[0].id;
                        localStorage.setItem('selectedBatchID', selectedBatchId);
                    }

                    const batchSelects = [
                        { el: document.getElementById('summary-batch-select'), useId: true },
                        { el: document.getElementById('files-batch-select'), useId: true },
                        { el: document.getElementById('placement-delete-batch-select'), useId: true },
                        { el: document.getElementById('result-batch-select'), useId: true },
                        { el: document.getElementById('intake-batch-select'), useId: true },
                        { el: document.getElementById('extracurricular-batch-select'), useId: true },
                        { el: document.getElementById('extracurricular-bulk-batch-select'), useId: true },
                        { el: document.getElementById('placement-batch-select'), useId: true },
                        { el: document.getElementById('placement-bulk-batch-select'), useId: true },
                        { el: document.getElementById('extracurricular-delete-batch-select'), useId: true }
                    ];
                    
                    batchSelects.forEach(item => {
                        const select = item.el;
                        if (!select) return;
                        
                        // Keep the first option (placeholder)
                        const firstOption = select.options[0];
                        select.innerHTML = '';
                        select.appendChild(firstOption);
                        
                        batches.forEach(batch => {
                            const option = document.createElement('option');
                            option.value = item.useId ? batch.id : batch.batch_range;
                            option.textContent = batch.batch_range;
                            select.appendChild(option);
                        });

                        // Set default value if it matches the stored ID (and uses ID as value)
                        if (selectedBatchId && item.useId) {
                            select.value = selectedBatchId;
                        }

                        // Add change listener to update localStorage
                        // Only for selectors that should drive the global state (e.g., summary, maybe uploads too if desired)
                        // For now, let's make them ALL update the global state to ensure consistency as requested
                        select.addEventListener('change', (e) => {
                            if (e.target.value && item.useId) {
                                localStorage.setItem('selectedBatchID', e.target.value);
                            }
                        });
                    });
                } catch (error) {
                    console.error('❌ Error loading batches:', error);
                }
            }


            // other elements used in scripts
            const modalOverlay = document.getElementById('modal-overlay');
            const confirmModal = document.getElementById('confirm-modal');
            const resultModal = document.getElementById('result-modal');
            const confirmFilename = document.getElementById('confirm-filename');
            const confirmBtn = document.getElementById('confirm-upload-btn');
            const cancelBtn = document.getElementById('cancel-upload-btn');
            const confirmActions = document.getElementById('confirm-actions');
            const uploadSpinner = document.getElementById('upload-spinner');
            const resultIconBg = document.getElementById('result-icon-bg');
            const resultIcon = document.getElementById('result-icon');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            const resultCloseBtn = document.getElementById('result-close-btn');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const logoutOverlay = document.getElementById('logout-overlay');
            const logoutCancel = document.getElementById('logout-cancel');
            const logoutConfirm = document.getElementById('logout-confirm');
            const duplicateModal = document.getElementById('duplicate-modal');
            const duplicateFilename = document.getElementById('duplicate-filename');
            const duplicateCancelBtn = document.getElementById('duplicate-cancel-btn');
            const duplicateReplaceBtn = document.getElementById('duplicate-replace-btn');

            // Extracurricular controls (bulk upload removed)
            const kpiArea = document.getElementById('kpi-upload-area');
            const kpiInput = document.getElementById('kpi-file-input');

            // state
            let fileToUpload = null;
            let uploadEndpoint = '';
            let fileToDelete = null;
            let fileToDeleteType = null;
            let fileToDeleteParams = {};
            let currentViewFileId = null;
            let currentViewFileUrl = null;

            // ----- FILE INPUT / UPLOAD UX -----
            function updateFileInputAccept() {
                fileInput.accept = '.xlsx,.xls';
                
                // Show Excel requirements section
                const excelRequirements = document.getElementById('excel-requirements');
                if (excelRequirements) {
                    excelRequirements.classList.remove('hidden');
                }
            }
            updateFileInputAccept();

            // KPI upload handlers
            if (kpiArea && kpiInput) {
                kpiArea.addEventListener('click', () => {
                    const selectedBatch = intakeBatchSelect.value;
                    if (!selectedBatch) { showAlert('Please select a batch first.', 'warning'); return; }
                    kpiInput.click();
                });
                kpiInput.addEventListener('change', async (e) => {
                    if (!e.target.files.length) return;
                    const selectedBatch = intakeBatchSelect.value;
                    if (!selectedBatch) { showAlert('Please select a batch first.', 'warning'); return; }
                    const file = e.target.files[0];
                    showConfirmModal(file, '/api/upload-admissions-kpis', 'intake', 'excel');
                    e.target.value = null;
                });
            }

            uploadArea.addEventListener('click', () => {
                const selectedSemester = semesterSelect.value;
                const selectedBatch = resultBatchSelect.value;
                if (!selectedBatch) { showAlert('Please select a batch first.', 'warning'); return; }
                if (!selectedSemester) { showAlert('Please select a semester first.', 'warning'); return; }
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    const selectedSemester = semesterSelect.value;
                    const selectedBatch = resultBatchSelect.value;
                    if (!selectedBatch) { showAlert('Please select a batch first.', 'warning'); return; }
                    if (!selectedSemester) { showAlert('Please select a semester first.', 'warning'); return; }
                    const endpoint = '/api/upload-result-file';
                    showConfirmModal(e.target.files[0], endpoint, selectedSemester, 'excel');
                    e.target.value = null;
                }
            });

            // ----- MODALS / UPLOAD FLOW -----
            function showConfirmModal(file, endpoint, semester, fileType) {
                fileToUpload = file;
                uploadEndpoint = endpoint;
                confirmFilename.textContent = `${file.name} (${(semester || '').toUpperCase()})`;
                modalOverlay.classList.remove('hidden');
                confirmModal.classList.remove('hidden');
                resultModal.classList.add('hidden');
                confirmActions.classList.remove('hidden');
                uploadSpinner.classList.add('hidden');
                setupEnterKeyHandler(confirmBtn);
            }
            function showResultModal(status, message, titleOverride) {
                // Close all other modals first
                [confirmModal, deleteConfirmModal, duplicateModal].forEach(m => m.classList.add('hidden'));
                
                resultMessage.innerHTML = message || '';
                if (status === 'success') {
                    resultTitle.textContent = titleOverride || 'Success';
                    resultIconBg.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-green-500/20';
                    resultIcon.className = 'fa-solid fa-check text-green-500 text-xl';
                } else {
                    resultTitle.textContent = titleOverride || 'Error';
                    resultIconBg.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-red-500/20';
                    resultIcon.className = 'fa-solid fa-xmark text-red-500 text-xl';
                }
                resultModal.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
                setupEnterKeyHandler(resultCloseBtn);
            }
            // Global Enter key handler for modals
            let currentEnterHandler = null;
            let lastEnterPress = 0;
            const ENTER_DEBOUNCE_MS = 500; // Prevent rapid repeated presses
            
            function setupEnterKeyHandler(confirmButton) {
                // Remove previous listener if exists
                if (currentEnterHandler) {
                    document.removeEventListener('keydown', currentEnterHandler);
                }
                
                // Create new handler
                currentEnterHandler = (e) => {
                    if (e.key === 'Enter' && !modalOverlay.classList.contains('hidden')) {
                        const now = Date.now();
                        // Debounce: prevent rapid repeated presses
                        if (now - lastEnterPress < ENTER_DEBOUNCE_MS) {
                            e.preventDefault();
                            return;
                        }
                        lastEnterPress = now;
                        
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (confirmButton && !confirmButton.disabled) {
                            // Temporarily disable button to prevent double-clicks
                            confirmButton.disabled = true;
                            setTimeout(() => {
                                if (confirmButton) confirmButton.disabled = false;
                            }, 1000);
                            confirmButton.click();
                        }
                    }
                };
                
                document.addEventListener('keydown', currentEnterHandler);
            }
            
            function closeModal() {
                modalOverlay.classList.add('hidden');
                // hide all modals inside overlay
                [confirmModal, resultModal, deleteConfirmModal, duplicateModal].forEach(m => m.classList.add('hidden'));
                // Don't clear fileToUpload here - it might still be needed for upload
                // Only clear it when upload is complete or cancelled
                
                // Remove Enter key listener
                if (currentEnterHandler) {
                    document.removeEventListener('keydown', currentEnterHandler);
                    currentEnterHandler = null;
                }
            }
            
            function clearFileToUpload() {
                fileToUpload = null;
            }
            cancelBtn.addEventListener('click', () => {
                clearFileToUpload();
                closeModal();
            });
            resultCloseBtn.addEventListener('click', () => {
                clearFileToUpload();
                closeModal();
            });
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

            confirmBtn.addEventListener('click', async () => {
                if (!fileToUpload) {
                    console.error('fileToUpload is null');
                    showAlert('File is missing. Please select the file again.', 'error');
                    return;
                }
                
                // Validate file object
                if (!(fileToUpload instanceof File)) {
                    console.error('fileToUpload is not a File object:', fileToUpload);
                    showAlert('File is invalid. Please select the file again.', 'error');
                    return;
                }
                
                // Prevent double-clicks
                if (confirmBtn.disabled) return;
                confirmBtn.disabled = true;
                
                const selectedSemester = semesterSelect.value;
                let selectedBatch = null;
                
                // Determine which batch selector to use based on endpoint
                if (uploadEndpoint === '/api/upload-admissions-kpis') {
                    selectedBatch = intakeBatchSelect.value;
                } else if (uploadEndpoint === '/api/upload-result-file') {
                    selectedBatch = resultBatchSelect.value;
                }
                
                if (!selectedBatch) {
                    confirmBtn.disabled = false;
                    closeModal(); // Close confirmation modal first
                    showAlert('Please select a batch first.', 'warning');
                    return;
                }
                
                // Store file reference before closing modal (to prevent it from being cleared)
                const fileToUploadCopy = fileToUpload;
                
                // Close confirmation modal before checking duplicate
                confirmModal.classList.add('hidden');
                
                // check duplicate
                const existing = await findExistingFile(selectedSemester, fileToUploadCopy.name);
                if (existing) {
                    // show duplicate modal
                    duplicateFilename.textContent = `${fileToUploadCopy.name} (${selectedSemester.toUpperCase()})`;
                    duplicateModal.classList.remove('hidden');
                    setupEnterKeyHandler(duplicateReplaceBtn);
                    confirmBtn.disabled = false;
                    return;
                }
                
                // Don't close modal overlay - let handleUpload manage it
                // This ensures fileToUpload is not cleared
                handleUpload(fileToUploadCopy, uploadEndpoint, selectedSemester, selectedBatch);
            });

            // duplicate replace
            duplicateCancelBtn.addEventListener('click', () => {
                closeModal();
            });
            duplicateReplaceBtn.addEventListener('click', async () => {
                // Prevent double-clicks
                if (duplicateReplaceBtn.disabled) return;
                duplicateReplaceBtn.disabled = true;
                
                try {
                    const selectedSemester = semesterSelect.value;
                    let selectedBatch = null;
                    if (uploadEndpoint === '/api/upload-admissions-kpis') {
                        selectedBatch = intakeBatchSelect.value;
                    } else if (uploadEndpoint === '/api/upload-result-file') {
                        selectedBatch = resultBatchSelect.value;
                    }
                    const existing = await findExistingFile(selectedSemester, fileToUpload?.name || '');
                    if (existing) {
                        await fetch(`${API_BASE}/api/delete-result-file/${existing._id}`, { 
                            method: 'DELETE',
                            credentials: 'include'
                        });
                    }
                    closeModal(); // Close duplicate modal first
                    await handleUpload(fileToUpload, uploadEndpoint, selectedSemester, selectedBatch);
                } catch (err) {
                    closeModal();
                    showResultModal('error', 'Unable to replace file. Please try again.');
                } finally {
                    duplicateReplaceBtn.disabled = false;
                }
            });

            async function handleUpload(file, endpoint, semester, batchId) {
                // Validate file before proceeding
                if (!file || !(file instanceof File)) {
                    console.error('Invalid file object:', file);
                    resultCloseBtn.style.display = 'block';
                    showResultModal('error', 'File is invalid or has been lost. Please try selecting the file again.');
                    confirmBtn.disabled = false;
                    return;
                }
                
                // Close confirmation modal and show upload progress in result modal
                confirmModal.classList.add('hidden');
                resultModal.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
                resultTitle.textContent = 'Uploading...';
                resultMessage.innerHTML = 'Please wait while the file is being uploaded.';
                resultIconBg.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-blue-500/20';
                resultIcon.className = 'fa-solid fa-spinner fa-spin text-blue-500 text-xl';
                resultCloseBtn.style.display = 'none';

                const formData = new FormData();
                formData.append('file', file, file.name); // Include filename explicitly
                if (semester) formData.append('semester', semester);
                if (batchId) formData.append('batch_id', batchId);
                formData.append('file_type', document.querySelector('input[name="file-type"]:checked')?.value || 'excel');
                
                // Debug: Log FormData contents
                console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);
                console.log('FormData entries:');
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + (pair[1] instanceof File ? pair[1].name : pair[1]));
                }

                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    if (!response.ok) {
                        // try to parse JSON, fallback to text
                        let text = await response.text();
                        try { const json = JSON.parse(text); throw new Error(json.message || text || 'Upload failed'); } catch (e) { throw new Error(text || 'Upload failed'); }
                    }
                    const data = await response.json();
                    resultCloseBtn.style.display = 'block';
                    showResultModal('success', data.message || 'Upload successful');
                    try { localStorage.setItem('sps_last_upload', Date.now().toString()); } catch (e) {}
                    await loadFiles();
                    clearFileToUpload(); // Clear file after successful upload
                } catch (error) {
                    console.error('Upload Error:', error);
                    resultCloseBtn.style.display = 'block';
                    showResultModal('error', error.message || 'Upload error');
                    // Don't clear file on error - user might want to retry
                } finally {
                    confirmBtn.disabled = false;
                }
            }

            // ----- EXISTING FILE / LISTING -----
            async function findExistingFile(semester, filename) {
                try {
                    const response = await fetch(`${API_BASE}/api/get-result-files?semester=${encodeURIComponent(semester)}`, {
                        credentials: 'include'
                    });
                    if (!response.ok) return null;
                    const files = await response.json();
                    return (files || []).find(f => (f.filename || '').toLowerCase() === filename.toLowerCase());
                } catch (err) {
                    console.error('findExistingFile error', err);
                    return null;
                }
            }

            // Load batches into batch selectors
            async function loadBatchesForFiles() {
                // Logic removed to support free-text input for batches
                console.log('Batch dropdown population disabled for free-text input (files section)');
            }

            // load files and intake files
            async function loadFiles() {
                try {
                    console.log('🔄 Loading files...');
                    if (!filesList) {
                        console.error('❌ filesList element not found!');
                        return;
                    }
                    
                    // Show loading state
                    filesList.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fa-solid fa-spinner fa-spin text-4xl mb-2"></i>
                            <p>Loading files...</p>
                        </div>
                    `;
                    
                    const selectedBatch = filesBatchSelect ? filesBatchSelect.value : '';
                    const selectedType = filesTypeSelect ? filesTypeSelect.value.trim().toLowerCase() : '';
                    
                    console.log('📋 Batch filter:', selectedBatch || 'All Batches');
                    console.log('📋 Type filter:', selectedType);
                    
                    // Always fetch all file types to allow free-text filtering
                    const showResult = true;
                    const showIntake = true;
                    const showExtracurricular = true;
                    const showPlacement = true;
                    
                    const allFiles = [];
                    
                    // Fetch result files (semester files)
                    if (showResult) {
                        try {
                            let resultFilesUrl = `${API_BASE}/api/get-result-files`;
                            if (selectedBatch) {
                                resultFilesUrl += `?batch_id=${encodeURIComponent(selectedBatch)}`;
                            }
                            console.log('📥 Fetching result files from:', resultFilesUrl);
                            const resultFilesResp = await fetch(resultFilesUrl, { credentials: 'include' });
                            if (resultFilesResp.ok) {
                                const files = await resultFilesResp.json();
                                files.forEach(file => {
                                    allFiles.push({
                                        ...file,
                                        file_category: 'result',
                                        display_type: `Result File (${file.semester?.toUpperCase() || 'N/A'})`
                                    });
                                });
                                console.log(`✅ Loaded ${files.length} result files`);
                            } else {
                                console.error('❌ Failed to fetch result files:', resultFilesResp.status);
                            }
                        } catch (err) {
                            console.error('❌ Error fetching result files:', err);
                        }
                    }

                    // Fetch intake files
                    if (showIntake) {
                        try {
                            let intakeUrl = `${API_BASE}/api/get-intake-files`;
                            if (selectedBatch) {
                                intakeUrl += `?batch_id=${encodeURIComponent(selectedBatch)}`;
                            }
                            console.log('📥 Fetching intake files...');
                            const intakeResp = await fetch(intakeUrl, { credentials: 'include' });
                            if (intakeResp.ok) {
                                const intakeFiles = await intakeResp.json();
                                intakeFiles.forEach(file => {
                                    allFiles.push({
                                        ...file,
                                        file_category: 'intake',
                                        display_type: 'Intake File'
                                    });
                                });
                                console.log(`✅ Loaded ${intakeFiles.length} intake files`);
                            } else {
                                console.error('❌ Failed to fetch intake files:', intakeResp.status);
                            }
                        } catch (err) {
                            console.error('❌ Error fetching intake files:', err);
                        }
                    }

                    // Fetch extracurricular files
                    if (showExtracurricular) {
                        try {
                            let extraUrl = `${API_BASE}/api/get-extracurricular-files`;
                            if (selectedBatch) {
                                extraUrl += `?batch_id=${encodeURIComponent(selectedBatch)}`;
                            }
                            console.log('📥 Fetching extracurricular files...');
                            const extracurricularResp = await fetch(extraUrl, { credentials: 'include' });
                            if (extracurricularResp.ok) {
                                const extracurricularFiles = await extracurricularResp.json();
                                extracurricularFiles.forEach(file => {
                                    allFiles.push({
                                        ...file,
                                        file_category: 'extracurricular',
                                        display_type: 'Extracurricular File'
                                    });
                                });
                                console.log(`✅ Loaded ${extracurricularFiles.length} extracurricular files`);
                            } else {
                                console.error('❌ Failed to fetch extracurricular files:', extracurricularResp.status);
                            }
                        } catch (err) {
                            console.error('❌ Error fetching extracurricular files:', err);
                        }
                    }

                    // Fetch placement outcome files
                    if (showPlacement) {
                        try {
                            let placementUrl = `${API_BASE}/api/get-placement-files`;
                            if (selectedBatch) {
                                placementUrl += `?batch_id=${encodeURIComponent(selectedBatch)}`;
                            }
                            console.log('📥 Fetching placement files...');
                            const placementResp = await fetch(placementUrl, { credentials: 'include' });
                            if (placementResp.ok) {
                                const placementFiles = await placementResp.json();
                                placementFiles.forEach(file => {
                                    const outcome = file.outcome_type || 'All';
                                    const year = file.year || 'N/A';
                                    allFiles.push({
                                        ...file,
                                        file_category: 'placement',
                                        display_type: `Career Outcomes (${outcome}, ${year})`
                                    });
                                });
                                console.log(`✅ Loaded ${placementFiles.length} placement files`);
                            } else {
                                console.error('❌ Failed to fetch placement files:', placementResp.status);
                            }
                        } catch (err) {
                            console.error('❌ Error fetching placement files:', err);
                        }
                    }
                    
                    // Filter by type if text is entered
                    const filteredFiles = selectedType ? allFiles.filter(file => {
                        const typeMatch = (file.display_type && file.display_type.toLowerCase().includes(selectedType));
                        const catMatch = (file.file_category && file.file_category.toLowerCase().includes(selectedType));
                        return typeMatch || catMatch;
                    }) : allFiles;

                    // Sort by uploaded_at (newest first)
                    filteredFiles.sort((a, b) => {
                        const dateA = new Date(a.uploaded_at || a.created_at || 0);
                        const dateB = new Date(b.uploaded_at || b.created_at || 0);
                        return dateB - dateA;
                    });
                    
                    console.log(`📊 Total files: ${allFiles.length}, Filtered: ${filteredFiles.length}`);

                    if (filteredFiles.length === 0) {
                        filesList.innerHTML = `
                            <div class="text-center text-gray-400 py-8">
                                <i class="fa-solid fa-folder-open text-4xl mb-2 opacity-50"></i>
                                <p class="text-lg">No files match your search</p>
                            </div>
                        `;
                        return;
                    }

                    let filesHtml = '';
                    filteredFiles.forEach(file => {
                        const rawDate = file.uploaded_at || file.created_at || '';
                        let formattedDate = '';
                        if (rawDate) {
                            let iso = String(rawDate);
                            const hasTZ = /[zZ]|[+-]\d{2}:\d{2}$/.test(iso);
                            if (!hasTZ) {
                                iso = iso + 'Z';
                            }
                            const uploadDate = new Date(iso);
                            formattedDate =
                                uploadDate.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' }) +
                                ' ' +
                                uploadDate.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });
                        }
                        const batchRange = file.batch_range || 'N/A';
                        
                        let iconClass = 'fa-file-excel';
                        let iconColor = 'text-blue-500';
                        let downloadBtn = '';
                        let deleteBtn = '';
                        
                        if (file.file_category === 'result') {
                            iconClass = file.file_type === 'excel' ? 'fa-file-excel' : 'fa-file-pdf';
                            iconColor = file.file_type === 'excel' ? 'text-blue-500' : 'text-red-500';
                            downloadBtn = `<button onclick="downloadFile('${file._id}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                <i class="fa-solid fa-download mr-1"></i>Download
                            </button>`;
                            deleteBtn = `<button onclick="deleteFile('${file._id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                <i class="fa-solid fa-trash mr-1"></i>Delete File
                            </button>`;
                        } else if (file.file_category === 'intake') {
                            iconClass = 'fa-table';
                            iconColor = 'text-blue-500';
                            deleteBtn = `<button onclick="deleteIntakeFile('${file._id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                <i class="fa-solid fa-trash mr-1"></i>Delete
                            </button>`;
                        } else if (file.file_category === 'extracurricular') {
                            const fileType = file.file_type || 'bulk';
                            iconClass = fileType === 'bulk' ? 'fa-file-excel' : 'fa-file-image';
                            iconColor = fileType === 'bulk' ? 'text-purple-500' : 'text-green-500';
                            downloadBtn = `<button onclick="downloadExtracurricularFile('${file.file_id}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                <i class="fa-solid fa-download mr-1"></i>Download
                            </button>`;
                            deleteBtn = `<button onclick="deleteExtracurricularFile('${file._id}', '${file.file_id}', '${fileType}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                <i class="fa-solid fa-trash mr-1"></i>Delete File
                            </button>`;
                        } else if (file.file_category === 'placement') {
                            iconClass = 'fa-briefcase';
                            iconColor = 'text-green-500';
                            downloadBtn = `<button onclick="downloadPlacementFile('${file._id}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                <i class="fa-solid fa-download mr-1"></i>Download
                            </button>`;
                            deleteBtn = `<button onclick="deletePlacementFile('${file._id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                <i class="fa-solid fa-trash mr-1"></i>Delete File
                            </button>`;
                        }
                        
                        const recordInfo = file.record_count ? ` • ${file.record_count} records` : '';
                        
                        filesHtml += `
                            <div class="bg-gray-700 p-4 rounded-lg flex items-center justify-between">
                                <div class="flex items-center space-x-4 flex-1 min-w-0">
                                    <i class="fa-solid ${iconClass} ${iconColor} text-2xl"></i>
                                    <div class="flex-1 min-w-0">
                                        <h5 class="text-white font-semibold truncate">${file.filename || 'Unknown File'}</h5>
                                        <p class="text-gray-400 text-sm">${file.display_type} • Batch: ${batchRange} • ${formattedDate}${recordInfo}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    ${downloadBtn}
                                    ${deleteBtn}
                                </div>
                            </div>
                        `;
                    });

                    if (filesHtml) {
                        filesList.innerHTML = filesHtml;
                        console.log('✅ Files displayed successfully');
                    } else {
                        filesList.innerHTML = `
                            <div class="text-center text-gray-400 py-8">
                                <i class="fa-solid fa-folder-open text-4xl mb-2"></i>
                                <p>No files found</p>
                            </div>
                        `;
                        console.log('ℹ️ No files to display');
                    }
                } catch (error) {
                    console.error('❌ Error loading files:', error);
                    if (filesList) {
                        filesList.innerHTML = `
                            <div class="text-center text-red-400 py-8">
                                <i class="fa-solid fa-exclamation-triangle text-4xl mb-2"></i>
                                <p>Error loading files</p>
                                <p class="text-sm text-red-300 mt-2">${error.message || 'Unknown error'}</p>
                            </div>
                        `;
                    }
                }
            }

            // global functions used in markup
            window.downloadFile = async function(fileId) {
                try {
                    const response = await fetch(`${API_BASE}/api/download-result-file/${fileId}`, { credentials: 'include' });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'file';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showResultModal('success', 'File downloaded successfully');
                    } else {
                        let data;
                        try { data = await response.json(); } catch(e){ }
                        showResultModal('error', (data && data.message) || 'Error downloading file');
                    }
                } catch (error) {
                    console.error('Error downloading file:', error);
                    showResultModal('error', 'Error downloading file: ' + error.message);
                }
            };

            window.deleteFile = function(fileId) {
                fileToDelete = fileId;
                fileToDeleteType = 'result';
                const warningText = document.getElementById('delete-warning-text');
                if (warningText) {
                    warningText.textContent = 'Deleting this semester result file will permanently remove all academic data derived from it (CGPA, backlogs, API, graphs). This action cannot be undone.';
                }
                modalOverlay.classList.remove('hidden');
                deleteConfirmModal.classList.remove('hidden');
                setupEnterKeyHandler(confirmDeleteBtn);
            };

            window.deleteIntakeFile = async function(fileId) {
                showConfirm('Are you sure you want to delete this intake file?', async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/delete-intake-file/${fileId}?finalize=false`, { 
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        if (response.ok) {
                            await loadFiles();
                            showUndoToast('Intake file', async () => {
                                try {
                                    await fetch(`${API_BASE}/api/delete-intake-file/${fileId}?finalize=true`, { 
                                        method: 'DELETE',
                                        credentials: 'include'
                                    });
                                } catch (e) {}
                            }, async () => {
                                try {
                                    const restoreRes = await fetch(`${API_BASE}/api/restore-intake-file/${fileId}`, { 
                                        method: 'POST',
                                        credentials: 'include'
                                    });
                                    if (restoreRes.ok) {
                                        await loadFiles();
                                    }
                                } catch (e) {}
                            });
                        } else {
                            const data = await response.json();
                            showAlert(data.message || 'Error deleting intake file', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting intake file:', error);
                        showAlert('Error deleting intake file: ' + error.message, 'error');
                    }
                });
            };

            window.downloadExtracurricularFile = async function(fileId) {
                try {
                    const response = await fetch(`${API_BASE}/api/download-extracurricular-file/${fileId}`, { credentials: 'include' });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'extracurricular_file';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showResultModal('success', 'File downloaded successfully');
                    } else {
                        let data;
                        try { data = await response.json(); } catch(e){ }
                        showResultModal('error', (data && data.message) || 'Error downloading file');
                    }
                } catch (error) {
                    console.error('Error downloading extracurricular file:', error);
                    showResultModal('error', 'Error downloading file: ' + error.message);
                }
            };

            window.downloadPlacementFile = async function(fileId) {
                try {
                    const response = await fetch(`${API_BASE}/api/download-placement-file/${fileId}`, { credentials: 'include' });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'placement_outcomes';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showResultModal('success', 'File downloaded successfully');
                    } else {
                        let data;
                        try { data = await response.json(); } catch(e){ }
                        showResultModal('error', (data && data.message) || 'Error downloading file');
                    }
                } catch (error) {
                    console.error('Error downloading placement file:', error);
                    showResultModal('error', 'Error downloading file: ' + error.message);
                }
            };

            window.deletePlacementFile = async function(fileId) {
                fileToDelete = fileId;
                fileToDeleteType = 'placement';
                const warningText = document.getElementById('delete-warning-text');
                if (warningText) {
                    warningText.textContent = 'Deleting this career outcome file will permanently remove all placement data derived from it. This action cannot be undone.';
                }
                modalOverlay.classList.remove('hidden');
                deleteConfirmModal.classList.remove('hidden');
                setupEnterKeyHandler(confirmDeleteBtn);
            };

            window.deleteExtracurricularFile = async function(recordId, fileId, fileType) {
                fileToDelete = recordId;
                fileToDeleteType = 'extracurricular';
                fileToDeleteParams = { fileId: fileId, fileType: fileType };
                const warningText = document.getElementById('delete-warning-text');
                if (warningText) {
                    warningText.textContent = 'Deleting this extracurricular file will permanently remove all activity data derived from it. This action cannot be undone.';
                }
                modalOverlay.classList.remove('hidden');
                deleteConfirmModal.classList.remove('hidden');
                setupEnterKeyHandler(confirmDeleteBtn);
            };

            // delete modal handlers
            cancelDeleteBtn.addEventListener('click', () => {
                modalOverlay.classList.add('hidden');
                deleteConfirmModal.classList.add('hidden');
                fileToDelete = null;
                fileToDeleteType = null;
                fileToDeleteParams = {};
            });
            confirmDeleteBtn.addEventListener('click', async () => {
                if (!fileToDelete) return;
                
                // Close modal immediately as requested
                modalOverlay.classList.add('hidden');
                deleteConfirmModal.classList.add('hidden');
                
                confirmDeleteBtn.disabled = true;
                cancelDeleteBtn.disabled = true;
                
                let url = '';
                let finalizeUrl = '';
                let restoreUrl = '';
                let label = '';
                let reloadFunction = null;
                
                if (fileToDeleteType === 'extracurricular') {
                    const { fileId, fileType } = fileToDeleteParams || {};
                    url = `${API_BASE}/api/delete-extracurricular-file/${fileToDelete}?file_type=${fileType || 'bulk'}&file_id=${fileId || ''}&finalize=false`;
                    finalizeUrl = `${API_BASE}/api/delete-extracurricular-file/${fileToDelete}?file_type=${fileType || 'bulk'}&file_id=${fileId || ''}&finalize=true`;
                    restoreUrl = `${API_BASE}/api/restore-extracurricular-file/${fileToDelete}`;
                    label = 'Extracurricular file';
                    reloadFunction = window.loadExtracurricularRecords;
                } else if (fileToDeleteType === 'placement') {
                    url = `${API_BASE}/api/delete-placement-file/${fileToDelete}?finalize=false`;
                    finalizeUrl = `${API_BASE}/api/delete-placement-file/${fileToDelete}?finalize=true`;
                    restoreUrl = `${API_BASE}/api/restore-placement-file/${fileToDelete}`;
                    label = 'Career outcome file';
                    reloadFunction = window.loadPlacementRecords;
                } else {
                    // Default to result file
                    url = `${API_BASE}/api/delete-result-file/${fileToDelete}?finalize=false`;
                    finalizeUrl = `${API_BASE}/api/delete-result-file/${fileToDelete}?finalize=true`;
                    restoreUrl = `${API_BASE}/api/restore-result-file/${fileToDelete}`;
                    label = 'Semester file';
                    reloadFunction = loadFiles;
                }
                
                try {
                    // Step 1: Soft delete (finalize=false)
                    const response = await fetch(url, { 
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        // Immediately reload to hide the item
                        if (reloadFunction) await reloadFunction();
                        
                        // Show Undo Toast
                        showUndoToast(label, async () => {
                            // On Finalize (Timeout or page unload)
                            try {
                                await fetch(finalizeUrl, { 
                                    method: 'DELETE',
                                    credentials: 'include',
                                    keepalive: true
                                });
                            } catch (e) {
                                console.error('Error finalizing delete:', e);
                            }
                        }, async () => {
                            // On Undo
                            try {
                                const restoreRes = await fetch(restoreUrl, { 
                                    method: 'POST',
                                    credentials: 'include'
                                });
                                if (restoreRes.ok) {
                                    if (reloadFunction) await reloadFunction();
                                } else {
                                    showAlert('Failed to restore item', 'error');
                                }
                            } catch (e) {
                                console.error('Error restoring item:', e);
                                showAlert('Error restoring item: ' + e.message, 'error');
                            }
                        });
                        
                    } else {
                        let data;
                        try { data = await response.json(); } catch(e){}
                        showAlert((data && data.message) || 'Error deleting file', 'error');
                    }
                } catch (err) {
                    showAlert('Error deleting file: ' + err.message, 'error');
                } finally {
                    fileToDelete = null;
                    fileToDeleteType = null;
                    fileToDeleteParams = {};
                    confirmDeleteBtn.disabled = false;
                    cancelDeleteBtn.disabled = false;
                }
            });

            // Download summary
            const downloadSummaryBtn = document.getElementById('download-summary-btn');
            downloadSummaryBtn.addEventListener('click', async () => {
                const selectedBatch = summaryBatchSelect ? summaryBatchSelect.value : '';
                
                if (!selectedBatch) {
                    showResultModal('error', 'Please select a batch first');
                    return;
                }
                
                try {
                    downloadSummaryBtn.disabled = true;
                    downloadSummaryBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Downloading...';
                    
                    let url = `${API_BASE}/api/export-result-summary?batch_id=${encodeURIComponent(selectedBatch)}`;
                    const res = await fetch(url, { credentials: 'include' });
                    
                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error(text || 'Unable to download');
                    }
                    
                    const blob = await res.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    
                    // Get batch name for filename
                    const batchOption = summaryBatchSelect.options[summaryBatchSelect.selectedIndex];
                    const batchName = batchOption ? batchOption.textContent.replace(/\s+/g, '_') : 'Result';
                    a.download = `Result_Summary_${batchName}.xlsx`;
                    
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    showResultModal('success', 'Summary downloaded successfully');
                } catch (err) {
                    showResultModal('error', err.message || 'Download failed');
                } finally {
                    downloadSummaryBtn.disabled = false;
                    downloadSummaryBtn.innerHTML = '<i class="fa-solid fa-file-excel mr-2"></i>Download Summary';
                }
            });

            // logout flow
            if (logoutLink && logoutOverlay && logoutCancel && logoutConfirm) {
                logoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    logoutOverlay.classList.remove('hidden');
                });
                logoutCancel.addEventListener('click', () => {
                    logoutOverlay.classList.add('hidden');
                });
                logoutConfirm.addEventListener('click', () => {
                    localStorage.removeItem('loggedInUser');
                    sessionStorage.removeItem('sps_user');
                    window.location.href = 'index.html';
                });
            }

            // extra: extracurricular single form & bulk
            setupExtracurricular();

            // tabs
            setupTabs();

            // Event listeners for batch and type filters
            if (filesBatchSelect) {
                filesBatchSelect.addEventListener('change', loadFiles);
            }
            if (filesTypeSelect) {
                filesTypeSelect.addEventListener('change', loadFiles);
            }
            refreshFilesBtn.addEventListener('click', loadFiles);
            
            // Load batches and files on page load
            loadBatchesForFiles().then(() => {
                loadFiles();
            });
        });

        // Tabs setup (keeps your original behavior)
        function setupTabs() {
            const tabs = {
                'tab-semester': 'content-semester',
                'tab-extracurricular': 'content-extracurricular',
                'tab-placement': 'content-placement'
            };
            Object.keys(tabs).forEach(tabId => {
                const tabButton = document.getElementById(tabId);
                const contentId = tabs[tabId];
                if (tabButton) {
                    tabButton.addEventListener('click', () => {
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                        document.querySelectorAll('.tab-button').forEach(btn => {
                            btn.classList.remove('bg-blue-600/20', 'border-b-2', 'border-blue-500', 'text-white');
                            btn.classList.add('text-slate-300');
                        });
                        const content = document.getElementById(contentId);
                        if (content) content.classList.remove('hidden');
                        tabButton.classList.add('bg-blue-600/20', 'border-b-2', 'border-blue-500', 'text-white');
                        tabButton.classList.remove('text-slate-300');
                        
                        // Load placement records when placement tab is clicked
                        if (tabId === 'tab-placement') {
                            setTimeout(() => {
                                if (typeof window.loadPlacementRecords === 'function') {
                                    window.loadPlacementRecords();
                                }
                            }, 100);
                        }
                        // Load extracurricular records when extracurricular tab is clicked
                        if (tabId === 'tab-extracurricular') {
                            setTimeout(() => {
                                if (typeof window.loadExtracurricularRecords === 'function') {
                                    window.loadExtracurricularRecords();
                                }
                            }, 100);
                        }
                    });
                }
            });
        }

            // Extracurricular form handling + bulk upload
            function setupExtracurricular() {
                const API_BASE = 'http://127.0.0.1:5001';
            
            // Dynamic form rendering based on output type
            const outputTypeSelect = document.getElementById('extracurricular-output-type');
            const extracurricularDynamicFields = document.getElementById('extracurricular-dynamic-fields');
            
            function renderDynamicFields(outputType) {
                if (!extracurricularDynamicFields) return;
                extracurricularDynamicFields.innerHTML = '';
                
                if (!outputType) return;
                
                let fieldsHTML = '';
                
                switch(outputType) {
                    case 'Sports':
                        fieldsHTML = `
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Sports Name</label>
                                <input type="text" name="sports_name"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Football, Cricket">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Level</label>
                                <input type="text" name="level"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Inter-college, National">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Number of Participants <span class="text-red-400">*</span></label>
                                    <input type="number" name="number_of_participants" required min="1"
                                        class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Number of Wins</label>
                                    <input type="number" name="number_of_wins" min="0"
                                        class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Names of Students (Optional)</label>
                                <textarea name="student_names" rows="2"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Student1, Student2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span></label>
                                <input type="file" name="evidence_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        `;
                        break;
                        
                    case 'Cultural':
                        fieldsHTML = `
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Event Category <span class="text-red-400">*</span></label>
                                <input type="text" name="event_category" id="cultural-event-category" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Student Activity, Youth Festival">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Event Name <span class="text-red-400">*</span></label>
                                <input type="text" name="event_name" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Annual Fest, Cultural Day">
                            </div>
                            <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Number of Students Participated <span class="text-red-400">*</span></label>
                    <input type="number" name="number_of_students" required min="1"
                        class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Organizer (Optional)</label>
                    <input type="text" name="organizer"
                        class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., Institute Name / Organizer Name / Company Name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Names of Students (Optional)</label>
                    <textarea name="student_names" rows="2"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Student1, Student2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span></label>
                                <input type="file" name="evidence_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        `;
                        break;
                        
                    case 'Technical':
                        fieldsHTML = `
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Event Type <span class="text-red-400">*</span></label>
                                <input type="text" name="event_type" id="technical-event-type" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Hackathon, Workshop">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Event Name <span class="text-red-400">*</span></label>
                                <input type="text" name="event_name" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., CodeHack 2024">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Organizer <span class="text-red-400">*</span></label>
                                <input type="text" name="organizer" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., IIT Bombay, TechFest">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Level <span class="text-red-400">*</span></label>
                                <input type="text" name="level" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. State, National">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Number of Students Participated <span class="text-red-400">*</span></label>
                                <input type="number" name="number_of_students" required min="1"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Achievement <span class="text-red-400">*</span></label>
                                <input type="text" name="achievement" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Winner, Runner-up">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Names of Students (Optional)</label>
                                <textarea name="student_names" rows="2"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Student1, Student2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span></label>
                                <input type="file" name="evidence_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        `;
                        break;
                        
                    case 'Internship':
                        fieldsHTML = `
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Internship Domain / Title <span class="text-red-400">*</span></label>
                                <input type="text" name="internship_domain" id="internship-domain-select" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Web Development, AI">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Organization / Company Name <span class="text-red-400">*</span></label>
                                <input type="text" name="organization_name" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Google, Microsoft">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Mode <span class="text-red-400">*</span></label>
                                <input type="text" name="mode" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Online, Offline">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Number of Students <span class="text-red-400">*</span></label>
                                <input type="number" name="number_of_students" required min="1"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Names of Students (Optional)</label>
                                <textarea name="student_names" rows="2"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Student1, Student2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Duration <span class="text-red-400">*</span></label>
                                <input type="text" name="duration" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 3 months, 6 weeks">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Stipend Provided? <span class="text-red-400">*</span></label>
                                <input type="text" name="has_stipend" required id="internship-has-stipend"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Yes / No">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Stipend Amount (Optional)</label>
                                <input type="number" name="stipend_amount" min="0"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Enter amount if applicable">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span></label>
                                <input type="file" name="evidence_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        `;
                        break;
                        
                    case 'Courses':
                        fieldsHTML = `
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Mode <span class="text-red-400">*</span></label>
                                <input type="text" name="mode" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g. Online, Offline">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Platform <span class="text-red-400">*</span></label>
                                <input type="text" name="platform" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., NPTEL, Coursera, Udemy, IIT, Company">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Course Name <span class="text-red-400">*</span></label>
                                <input type="text" name="course_name" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Machine Learning, Web Development">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Number of Students Completed <span class="text-red-400">*</span></label>
                                <input type="number" name="number_of_students" required min="1"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Duration <span class="text-red-400">*</span></label>
                                <input type="text" name="duration" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 8 weeks, 3 months">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Names of Students (Optional)</label>
                                <textarea name="student_names" rows="2"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Student1, Student2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span></label>
                                <input type="file" name="evidence_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        `;
                        break;
                        
                    case 'Industrial Visit':
                        fieldsHTML = `
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Industrial Visit Details <span class="text-red-400">*</span></label>
                                <input type="text" name="industrial_visit_details" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., Visit to XYZ Industry, Plant name, Location">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Date of Visit <span class="text-red-400">*</span></label>
                                <input type="text" name="iv_date" required
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 2024-03-15 or 15/03/2024">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Total Students Visited <span class="text-red-400">*</span></label>
                                <input type="number" name="total_students" required min="1"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">No. of Faculty (Optional)</label>
                                <input type="number" name="number_of_faculty" min="0"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="e.g., 2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Report / Proof / Supporting Document <span class="text-xs text-slate-400">(Optional)</span></label>
                                <input type="file" name="evidence_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                    class="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        `;
                        break;
                }
                
                extracurricularDynamicFields.innerHTML = fieldsHTML;
            }
            
            if (outputTypeSelect) {
                outputTypeSelect.addEventListener('change', (e) => {
                    renderDynamicFields(e.target.value);
                });
            }
            
            const singleForm = document.getElementById('extracurricular-single-form');
            if (singleForm) {
                singleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = singleForm;
                    const formData = new FormData(form);

                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    try {
                        // Check batch_id
                        const batchId = formData.get('batch_id');
                        if (!batchId) {
                            showAlert('Please select a batch', 'warning');
                            return;
                        }
                        
                        // Get output type
                        const outputType = formData.get('output_type');
                        if (!outputType) {
                            showAlert('Please select an Output Type', 'warning');
                            return;
                        }

                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Adding...';

                        const response = await fetch(`${API_BASE}/api/extracurricular`, { 
                            method: 'POST', 
                            credentials: 'include',
                            body: formData 
                        });
                        const result = await response.json();
                        if (response.ok) {
                            showAlert('Record added successfully!', 'success');
                            form.reset();
                            if (extracurricularDynamicFields) extracurricularDynamicFields.innerHTML = '';
                            // Reload records
                            if (typeof window.loadExtracurricularRecords === 'function') {
                                window.loadExtracurricularRecords();
                            }
                        } else {
                            showAlert('Error: ' + (result.message || 'Failed to add record'), 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        showAlert('Error: ' + err.message, 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                });
            }

            // Load and display extracurricular records (make it globally accessible)
            window.loadExtracurricularRecords = async function loadExtracurricularRecords() {
                try {
                    console.log('🔄 Loading extracurricular records...');
                    const recordsBody = document.getElementById('extracurricular-records-body');
                    const countElement = document.getElementById('extracurricular-records-count');
                    const batchSelect = document.getElementById('extracurricular-delete-batch-select');
                    
                    if (!recordsBody) {
                        console.error('❌ recordsBody element not found!');
                        return;
                    }
                    
                    // Show loading state
                    recordsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">Loading records...</td></tr>';
                    
                    let url = `${API_BASE}/api/extracurricular/records-list?per_page=100`;
                    
                    // Add batch filter if selected
                    if (batchSelect && batchSelect.value && batchSelect.value !== 'all') {
                        url += `&batch_id=${encodeURIComponent(batchSelect.value)}`;
                    }
                    
                    console.log('📥 Fetching from:', url);
                    
                    const response = await fetch(url, { credentials: 'include' });
                    console.log('📡 Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ API error:', response.status, errorText);
                        recordsBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-400">Error: ${response.status} - ${errorText}</td></tr>`;
                        if (countElement) {
                            countElement.textContent = 'Error';
                        }
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('✅ Received data:', result);
                    console.log('📊 Total records:', result.total || 0);
                    console.log('📋 Records array length:', result.records ? result.records.length : 0);
                    
                    if (countElement) {
                        countElement.textContent = result.total || 0;
                    }
                    
                    if (!result.records || result.records.length === 0) {
                        console.log('ℹ️ No records found');
                        recordsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">No records found</td></tr>';
                        return;
                    }
                    
                    console.log('🎨 Rendering', result.records.length, 'records...');
                    recordsBody.innerHTML = result.records.map(record => {
                        // Escape HTML to prevent XSS
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        let namesHtml = '';
                        const typeNorm = (record.output_type || '').toLowerCase();
                        if (typeNorm === 'internship' && Array.isArray(record.student_names) && record.student_names.length > 0) {
                            const sample = record.student_names.slice(0, 3).map(n => escapeHtml(n)).join(', ');
                            const remaining = record.student_names.length - 3;
                            const display = remaining > 0 ? `${sample} and ${remaining} more` : sample;
                            namesHtml = `<div class="text-xs text-slate-400 mt-1">Students: ${display}</div>`;
                        }
                        
                        return `
                            <tr class="border-b border-slate-700 hover:bg-slate-700/30">
                                <td class="py-3 px-4 text-white">${escapeHtml(record.output_type || 'N/A')}</td>
                                <td class="py-3 px-4 text-slate-300">${escapeHtml(record.details || 'N/A')}${namesHtml}</td>
                                <td class="py-3 px-4 text-right text-white font-semibold">${record.participants || 0}</td>
                                <td class="py-3 px-4 text-slate-300">${escapeHtml(record.academic_year || 'N/A')}</td>
                                <td class="py-3 px-4 text-slate-300 font-medium">${escapeHtml(record.batch_range || 'N/A')}</td>
                                <td class="py-3 px-4 text-center">
                                    <button 
                                        class="delete-extracurricular-record-btn px-3 py-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg transition-colors border border-red-500/30"
                                        data-id="${escapeHtml(record.id)}"
                                        data-details="${escapeHtml(record.details || record.output_type)}"
                                        title="Delete record"
                                    >
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    console.log('✅ Records rendered successfully');
                    
                    // Attach delete event listeners
                    document.querySelectorAll('.delete-extracurricular-record-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const recordId = btn.dataset.id;
                            const details = btn.dataset.details;
                            showConfirm(`Are you sure you want to delete this record?\n\n${details}`, () => {
                                deleteExtracurricularRecord(recordId);
                            });
                        });
                    });
                } catch (err) {
                    console.error('❌ Error loading extracurricular records:', err);
                    const recordsBody = document.getElementById('extracurricular-records-body');
                    const countElement = document.getElementById('extracurricular-records-count');
                    
                    // Handle network errors (Failed to fetch, ECONNREFUSED, etc.)
                    if (err.message === 'Failed to fetch' || err.name === 'TypeError' || err.message.includes('ECONNREFUSED')) {
                        console.error('🌐 Network error detected');
                        if (recordsBody) {
                            recordsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">Error loading records: Failed to fetch. Please check your connection.</td></tr>';
                        }
                        if (countElement) {
                            countElement.textContent = 'Error';
                        }
                    } else {
                        // Other errors
                        if (recordsBody) {
                            recordsBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-400">Error loading records: ${err.message || 'Unknown error'}</td></tr>`;
                        }
                        if (countElement) {
                            countElement.textContent = 'Error';
                        }
                    }
                }
            }

            async function deleteExtracurricularRecord(recordId) {
                try {
                    const response = await fetch(`${API_BASE}/api/extracurricular/records/${recordId}?finalize=false`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    const result = await response.json();
                    if (response.ok) {
                        if (typeof window.loadExtracurricularRecords === 'function') {
                            window.loadExtracurricularRecords();
                        }
                        showUndoToast('Extracurricular record', async () => {
                            try {
                                await fetch(`${API_BASE}/api/extracurricular/records/${recordId}?finalize=true`, {
                                    method: 'DELETE',
                                    credentials: 'include',
                                    keepalive: true
                                });
                            } catch (e) {}
                        }, async () => {
                            try {
                                const restoreRes = await fetch(`${API_BASE}/api/extracurricular/records/${recordId}/restore`, {
                                    method: 'POST',
                                    credentials: 'include'
                                });
                                if (restoreRes.ok && typeof window.loadExtracurricularRecords === 'function') {
                                    window.loadExtracurricularRecords();
                                }
                            } catch (e) {}
                        });
                    } else {
                        showAlert(`Failed to delete: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    console.error('Error deleting record:', err);
                    showAlert(`Error: ${err.message}`, 'error');
                }
            }

            // Note: Extracurricular records loading is now handled in setupTabs() function

            const placementTemplateBtn = document.getElementById('btn-download-placement-template');
            const placementBulkOutcomeTypeSelect = document.getElementById('placement-bulk-outcome-type');
            const placementBulkBatchSelect = document.getElementById('placement-bulk-batch-select');
            const placementBulkYearInput = document.getElementById('placement-bulk-year');
            const placementBulkFileInput = document.getElementById('placement-bulk-file');
            const placementDropZone = document.getElementById('placement-drop-zone');
            const placementValidationResult = document.getElementById('placement-validation-result');
            const placementCommitSection = document.getElementById('placement-commit-section');
            const placementCommitBtn = document.getElementById('btn-commit-placement-bulk');
            const btnCancelPlacementBulk = document.getElementById('btn-cancel-placement-upload');
            const btnReuploadPlacementBulk = document.getElementById('btn-reupload-placement-file');
            let placementBulkRecords = [];
            let placementBulkBatchId = null;
            let placementBulkYear = null;

            async function populatePlacementBulkBatchDropdown() {
                // Logic removed to support free-text input for batches
                console.log('Batch dropdown population disabled for free-text input (placement bulk)');
            }
            populatePlacementBulkBatchDropdown();

            if (placementTemplateBtn) {
                placementTemplateBtn.addEventListener('click', () => {
                    const outcomeType = placementBulkOutcomeTypeSelect ? placementBulkOutcomeTypeSelect.value : '';
                    if (!outcomeType) {
                        showAlert('Please select an Outcome Type to download its template.', 'warning');
                        return;
                    }
                    const url = `${API_BASE}/api/placement-outcomes/template?outcome_type=${encodeURIComponent(outcomeType)}`;
                    window.location.href = url;
                });
            }

            async function handlePlacementBulkUpload(file) {
                if (!file) return;
                const batchId = placementBulkBatchSelect ? placementBulkBatchSelect.value : '';
                const outcomeType = placementBulkOutcomeTypeSelect ? placementBulkOutcomeTypeSelect.value : '';
                if (!batchId) {
                    showAlert('Please select a batch first.', 'warning');
                    if (placementBulkFileInput) placementBulkFileInput.value = '';
                    return;
                }
                if (!outcomeType) {
                    showAlert('Please select the Outcome Type for this bulk upload.', 'warning');
                    if (placementBulkFileInput) placementBulkFileInput.value = '';
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);
                formData.append('batch_id', batchId);
                formData.append('outcome_type', outcomeType);
                if (placementValidationResult) {
                    placementValidationResult.classList.remove('hidden');
                    placementValidationResult.innerHTML = '<div class="text-center text-slate-300"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Validating file...</div>';
                }
                if (placementCommitSection) placementCommitSection.classList.add('hidden');
                placementBulkRecords = [];
                placementBulkBatchId = batchId;
                placementBulkYear = null;
                try {
                    const response = await fetch(`${API_BASE}/api/placement-outcomes/upload-bulk`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                    const result = await response.json();
                    if (response.ok) {
                        const invalidList = Array.isArray(result.invalid_records) ? result.invalid_records : (Array.isArray(result.errors) ? result.errors : []);
                        const invalidCount = invalidList.length;
                        let html = '';
                        html += `
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-green-900/20 border border-green-500/30 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-400">${result.valid_count || 0}</div>
                                    <div class="text-xs text-green-300">Valid Records</div>
                                </div>
                                <div class="bg-red-900/20 border border-red-500/30 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-red-400">${invalidCount}</div>
                                    <div class="text-xs text-red-300">Invalid Rows</div>
                                </div>
                            </div>
                        `;
                        if (invalidCount > 0) {
                            html += `
                                <div class="bg-red-900/10 border border-red-500/20 rounded-lg p-3 max-h-48 overflow-y-auto mb-4">
                                    <h6 class="text-red-400 text-sm font-semibold mb-2">Errors:</h6>
                                    <ul class="text-xs text-red-300 space-y-1">
                                        ${invalidList.map(err => `<li>Row ${err.row}: ${err.error}</li>`).join('')}
                                    </ul>
                                </div>
                                <p class="text-xs text-slate-400 mt-2 italic text-center"><i class="fa-solid fa-circle-info mr-1"></i> Fix errors in the file and re-upload</p>
                            `;
                        }
                        if (placementValidationResult) placementValidationResult.innerHTML = html;
                        
                        // ALWAYS show controls after validation
                        if (placementCommitSection) placementCommitSection.classList.remove('hidden');
                        
                        if (result.valid_count && result.valid_count > 0) {
                            placementBulkRecords = result.valid_records || [];
                            if (placementCommitBtn) {
                                placementCommitBtn.disabled = false;
                                placementCommitBtn.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> Commit ${result.valid_count} Valid Records`;
                            }
                        } else {
                            if (placementCommitBtn) {
                                placementCommitBtn.disabled = true;
                                placementCommitBtn.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> Commit Valid Records`;
                            }
                        }
                    } else if (placementValidationResult) {
                        placementValidationResult.innerHTML = `<div class="text-red-400 text-center"><i class="fa-solid fa-exclamation-circle mr-2"></i>${result.message || 'Validation failed'}</div>`;
                        // Show controls to allow retry
                        if (placementCommitSection) placementCommitSection.classList.remove('hidden');
                        if (placementCommitBtn) placementCommitBtn.disabled = true;
                    }
                } catch (err) {
                    console.error(err);
                    if (placementValidationResult) {
                        placementValidationResult.innerHTML = `<div class="text-red-400 text-center"><i class="fa-solid fa-exclamation-circle mr-2"></i>Error: ${err.message}</div>`;
                    }
                    // Show controls to allow retry
                    if (placementCommitSection) placementCommitSection.classList.remove('hidden');
                    if (placementCommitBtn) placementCommitBtn.disabled = true;
                }
            }

            if (placementBulkFileInput) {
                placementBulkFileInput.addEventListener('change', (e) => {
                    handlePlacementBulkUpload(e.target.files[0]);
                });
            }
            if (placementDropZone) {
                placementDropZone.addEventListener('click', () => {
                    if (placementBulkFileInput) placementBulkFileInput.click();
                });
                placementDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    placementDropZone.classList.add('border-blue-500', 'bg-slate-800');
                });
                placementDropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    placementDropZone.classList.remove('border-blue-500', 'bg-slate-800');
                });
                placementDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    placementDropZone.classList.remove('border-blue-500', 'bg-slate-800');
                    if (e.dataTransfer.files.length > 0 && placementBulkFileInput) {
                        placementBulkFileInput.files = e.dataTransfer.files;
                        handlePlacementBulkUpload(e.dataTransfer.files[0]);
                    }
                });
            }

            if (btnCancelPlacementBulk) {
                btnCancelPlacementBulk.addEventListener('click', () => {
                    if (placementBulkFileInput) placementBulkFileInput.value = '';
                    if (placementValidationResult) placementValidationResult.classList.add('hidden');
                    if (placementCommitSection) placementCommitSection.classList.add('hidden');
                    placementBulkRecords = [];
                    placementBulkBatchId = null;
                    placementBulkYear = null;
                });
            }

            if (btnReuploadPlacementBulk) {
                btnReuploadPlacementBulk.addEventListener('click', () => {
                    if (placementValidationResult) placementValidationResult.classList.add('hidden');
                    if (placementCommitSection) placementCommitSection.classList.add('hidden');
                    placementBulkRecords = [];
                    placementBulkBatchId = null;
                    placementBulkYear = null;
                    if (placementBulkFileInput) placementBulkFileInput.click();
                });
            }

            if (placementCommitBtn) {
                placementCommitBtn.addEventListener('click', async () => {
                    if (!placementBulkBatchId || placementBulkRecords.length === 0) return;
                    showConfirm(`Are you sure you want to commit ${placementBulkRecords.length} records?`, async () => {
                        try {
                            placementCommitBtn.disabled = true;
                            placementCommitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Committing...';
                            const response = await fetch(`${API_BASE}/api/placement-outcomes/upload-commit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                                    batch_id: placementBulkBatchId,
                                    year: placementBulkYear,
                                    records: placementBulkRecords
                                })
                            });
                            const result = await response.json();
                            if (response.ok) {
                                const inserted = typeof result.inserted_count === 'number' ? result.inserted_count : (placementBulkRecords.length || 0);
                                showAlert(`File uploaded successfully! Added ${inserted} records.`, 'success');
                                if (placementValidationResult) placementValidationResult.classList.add('hidden');
                                if (placementCommitSection) placementCommitSection.classList.add('hidden');
                                if (placementBulkFileInput) placementBulkFileInput.value = '';
                                if (placementBulkYearInput) placementBulkYearInput.value = '';
                                if (placementBulkBatchSelect) placementBulkBatchSelect.value = '';
                                if (placementBulkOutcomeTypeSelect) placementBulkOutcomeTypeSelect.value = '';
                                placementBulkRecords = [];
                                placementBulkBatchId = null;
                                placementBulkYear = null;
                                if (typeof window.loadPlacementRecords === 'function') {
                                    window.loadPlacementRecords();
                                }
                            } else {
                                showAlert(`Error: ${result.message || 'Failed to commit records'}`, 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            showAlert(`Error: ${err.message}`, 'error');
                        } finally {
                            placementCommitBtn.disabled = false;
                            placementCommitBtn.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i> Commit Valid Records';
                        }
                    });
                });
            }

            // ==========================================
            // Bulk Upload Extracurricular Logic
            // ==========================================
            
            const btnDownloadTemplate = document.getElementById('btn-download-extracurricular-template');
            const bulkFileInput = document.getElementById('extracurricular-bulk-file');
            const dropZone = document.getElementById('extracurricular-drop-zone');
            const validationResult = document.getElementById('extracurricular-validation-result');
            const commitSection = document.getElementById('extracurricular-commit-section');
            const btnCommitBulk = document.getElementById('btn-commit-extracurricular-bulk');
            const btnCancelBulk = document.getElementById('btn-cancel-extracurricular-upload');
            const btnReuploadBulk = document.getElementById('btn-reupload-extracurricular-file');
            const bulkBatchSelect = document.getElementById('extracurricular-bulk-batch-select');
            const bulkOutputTypeSelect = document.getElementById('extracurricular-bulk-output-type');
            let bulkFileId = null;
            let bulkFilename = null;
            
            let validBulkRecords = [];
            let bulkBatchId = null;

            // Populate Bulk Batch Dropdown (reuse existing batches)
        async function populateBulkBatchDropdown() {
            try {
                const datalist = document.getElementById('available-batches-list');
                if (!datalist) return;
                
                datalist.innerHTML = ''; // Clear existing
                
                // Use the existing API_BASE variable if available, otherwise assume relative path
                const baseUrl = (typeof API_BASE !== 'undefined') ? API_BASE : '';
                const response = await fetch(`${baseUrl}/api/batches`, { credentials: 'include' });
                
                if (response.ok) {
                    const batches = await response.json();
                    if (Array.isArray(batches)) {
                        batches.forEach(batch => {
                            const option = document.createElement('option');
                            option.value = batch.batch_range; // Use batch_range as the value
                            datalist.appendChild(option);
                        });
                        console.log(`Populated ${batches.length} batches for bulk upload suggestions`);
                    }
                } else {
                     console.error('Failed to fetch batches:', response.status);
                }
            } catch (err) {
                console.error('Error fetching batches for bulk upload:', err);
            }
        }
            // Call it initially
            populateBulkBatchDropdown();

            // Search and Delete All Logic
            const searchInput = document.getElementById('extracurricular-search');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const query = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#extracurricular-records-body tr');
                    rows.forEach(row => {
                        if (row.cells.length > 1) { // Skip loading/error rows
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(query) ? '' : 'none';
                        }
                    });
                });
            }

            const btnDeleteAll = document.getElementById('btn-delete-all-extracurricular');
            if (btnDeleteAll) {
                btnDeleteAll.addEventListener('click', () => {
                    const countSpan = document.getElementById('extracurricular-records-count');
                    // Remove non-numeric characters to handle cases like "(110)"
                    const countText = countSpan ? countSpan.textContent.replace(/[^\d]/g, '') : '0';
                    const count = parseInt(countText) || 0;
                    const batchSelect = document.getElementById('extracurricular-delete-batch-select');
                    const batchId = batchSelect ? batchSelect.value : '';
                    const batchLabel = (batchSelect && batchSelect.selectedIndex > 0) ? batchSelect.options[batchSelect.selectedIndex].textContent : '';
                    
                    if (count === 0) {
                        showAlert('No records to delete', 'warning');
                        return;
                    }
                    
                    let confirmMsg = 'Are you sure you want to DELETE ALL extracurricular records? This action cannot be undone and will delete all associated files.';
                    if (batchId) {
                        confirmMsg = `Are you sure you want to DELETE ALL extracurricular records for Batch '${batchLabel}'? This action cannot be undone.`;
                    }
                    
                    showConfirm(confirmMsg, async () => {
                        try {
                            const payload = {};
                            if (batchId) {
                                payload.batch_id = batchId;
                            }
                            
                            const response = await fetch(`${API_BASE}/api/extracurricular/records/delete_all`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify(payload)
                            });
                            const result = await response.json();
                            if (response.ok) {
                                showAlert(`Deleted ${result.deleted_count} records successfully`, 'success');
                                if (typeof window.loadExtracurricularRecords === 'function') {
                                    window.loadExtracurricularRecords();
                                }
                            } else {
                                showAlert(result.message || 'Error deleting records', 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            showAlert('Error: ' + err.message, 'error');
                        }
                    });
                });
            }

            // Batch filter change listener for Extracurricular
            const extracurricularBatchFilter = document.getElementById('extracurricular-delete-batch-select');
            if (extracurricularBatchFilter) {
                extracurricularBatchFilter.addEventListener('change', () => {
                    if (typeof window.loadExtracurricularRecords === 'function') {
                        window.loadExtracurricularRecords();
                    }
                });
            }

            // Placement Search and Delete All Logic
            const placementSearchInput = document.getElementById('placement-search');
            const placementBatchFilter = document.getElementById('placement-delete-batch-select');

            function filterPlacementRecords() {
                const query = placementSearchInput ? placementSearchInput.value.toLowerCase() : '';
                let batchFilter = '';
                if (placementBatchFilter) {
                    const idx = placementBatchFilter.selectedIndex;
                    batchFilter = idx > 0 ? (placementBatchFilter.options[idx].textContent || '').toLowerCase() : '';
                }
                
                const rows = document.querySelectorAll('#placement-records-body tr');
                rows.forEach(row => {
                    if (row.cells.length > 1) { // Skip loading/error rows
                        const text = row.textContent.toLowerCase();
                        const batchCell = row.cells[4]; // Index 4 is Batch column
                        const batchText = batchCell ? batchCell.textContent.toLowerCase() : '';
                        
                        const matchesSearch = !query || text.includes(query);
                        const matchesBatch = !batchFilter || batchText.includes(batchFilter);
                        
                        row.style.display = (matchesSearch && matchesBatch) ? '' : 'none';
                    }
                });
            }

            if (placementSearchInput) {
                placementSearchInput.addEventListener('keyup', filterPlacementRecords);
            }
            
            if (placementBatchFilter) {
                placementBatchFilter.addEventListener('change', filterPlacementRecords);
            }

            const btnDeleteAllPlacement = document.getElementById('btn-delete-all-placement');
            if (btnDeleteAllPlacement) {
                btnDeleteAllPlacement.addEventListener('click', () => {
                    const countSpan = document.getElementById('placement-records-count');
                    // Remove non-numeric characters to handle cases like "(110)"
                    const countText = countSpan ? countSpan.textContent.replace(/[^\d]/g, '') : '0';
                    const count = parseInt(countText) || 0;
                    const batchFilterSelect = document.getElementById('placement-delete-batch-select');
                    const batchId = batchFilterSelect ? batchFilterSelect.value : '';
                    const batchLabel = (batchFilterSelect && batchFilterSelect.selectedIndex > 0) ? batchFilterSelect.options[batchFilterSelect.selectedIndex].textContent : '';
                    
                    if (count === 0) {
                        showAlert('No records to delete', 'warning');
                        return;
                    }
                    
                    let confirmMsg = 'Are you sure you want to DELETE ALL career outcome records? This action cannot be undone and will delete all associated files.';
                    if (batchId) {
                        confirmMsg = `Are you sure you want to DELETE ALL career outcome records for Batch '${batchLabel}'? This action cannot be undone.`;
                    }
                    
                    showConfirm(confirmMsg, async () => {
                        try {
                            const payload = {};
                            if (batchId) {
                                payload.batch_id = batchId;
                            }
                            
                            const response = await fetch(`${API_BASE}/api/placement-outcomes/delete_all`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify(payload)
                            });
                            const result = await response.json();
                            if (response.ok) {
                                showAlert(`Deleted ${result.deleted_count} records successfully`, 'success');
                                if (typeof window.loadPlacementRecords === 'function') {
                                    window.loadPlacementRecords();
                                }
                            } else {
                                showAlert(result.message || 'Error deleting records', 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            showAlert('Error: ' + err.message, 'error');
                        }
                    });
                });
            }

            // Download Template
            if (btnDownloadTemplate) {
                btnDownloadTemplate.addEventListener('click', () => {
                    const selectedType = bulkOutputTypeSelect ? bulkOutputTypeSelect.value : '';
                    if (!selectedType) {
                        showAlert('Please select an Output Type to download its template.', 'warning');
                        return;
                    }
                    const url = `${API_BASE}/api/extracurricular/template?output_type=${encodeURIComponent(selectedType)}`;
                    window.location.href = url;
                });
            }

            // File Upload & Validation
            async function handleBulkUpload(file) {
                if (!file) return;

                const batchId = bulkBatchSelect.value;
                const outputType = bulkOutputTypeSelect ? bulkOutputTypeSelect.value : '';

                if (!batchId) {
                    showAlert('Please select a batch first.', 'warning');
                    bulkFileInput.value = '';
                    return;
                }
                if (!outputType) {
                    showAlert('Please select the Output Type for this bulk upload.', 'warning');
                    bulkFileInput.value = '';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('batch_id', batchId);
                formData.append('output_type', outputType);

                // Show loading
                validationResult.classList.remove('hidden');
                validationResult.innerHTML = '<div class="text-center text-slate-300"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Validating file...</div>';
                commitSection.classList.add('hidden');
                validBulkRecords = [];
                bulkBatchId = batchId;

                try {
                    const response = await fetch(`${API_BASE}/api/extracurricular/upload-bulk`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // Display results
                        let html = '';
                        
                        // Summary
                        html += `
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-green-900/20 border border-green-500/30 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-400">${result.valid_count}</div>
                                    <div class="text-xs text-green-300">Valid Records</div>
                                </div>
                                <div class="bg-red-900/20 border border-red-500/30 p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-red-400">${result.errors.length}</div>
                                    <div class="text-xs text-red-300">Invalid Rows</div>
                                </div>
                            </div>
                        `;
                        
                        // Error list
                        if (result.errors.length > 0) {
                            html += `
                                <div class="bg-red-900/10 border border-red-500/20 rounded-lg p-3 max-h-48 overflow-y-auto mb-4">
                                    <h6 class="text-red-400 text-sm font-semibold mb-2">Errors:</h6>
                                    <ul class="text-xs text-red-300 space-y-1">
                                        ${result.errors.map(err => `<li>Row ${err.row}: ${err.error}</li>`).join('')}
                                    </ul>
                                </div>
                                <p class="text-xs text-slate-400 mt-2 italic text-center"><i class="fa-solid fa-circle-info mr-1"></i> Fix errors in the file and re-upload</p>
                            `;
                        }
                        
                        validationResult.innerHTML = html;
                        
                        // ALWAYS show controls after validation so user can cancel/reupload
                        commitSection.classList.remove('hidden');
                        
                        // Enable commit ONLY if there are valid records
                        if (result.valid_count > 0) {
                            validBulkRecords = result.valid_records;
                            bulkFileId = result.file_id || null;
                            bulkFilename = result.filename || null;
                            btnCommitBulk.disabled = false;
                            btnCommitBulk.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> Commit ${result.valid_count} Valid Records`;
                        } else {
                            btnCommitBulk.disabled = true;
                            btnCommitBulk.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> Commit Valid Records`;
                        }
                        
                    } else {
                        validationResult.innerHTML = `<div class="text-red-400 text-center"><i class="fa-solid fa-exclamation-circle mr-2"></i>${result.message || 'Validation failed'}</div>`;
                        // Show controls to allow retry
                        commitSection.classList.remove('hidden');
                        btnCommitBulk.disabled = true;
                    }
                } catch (err) {
                    console.error(err);
                    validationResult.innerHTML = `<div class="text-red-400 text-center"><i class="fa-solid fa-exclamation-circle mr-2"></i>Error: ${err.message}</div>`;
                    // Show controls to allow retry
                    commitSection.classList.remove('hidden');
                    btnCommitBulk.disabled = true;
                }
            }

            // File Input Change
            if (bulkFileInput) {
                bulkFileInput.addEventListener('change', (e) => {
                    handleBulkUpload(e.target.files[0]);
                });
            }

            // Drag & Drop
            if (dropZone) {
                dropZone.addEventListener('click', () => bulkFileInput.click());
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-blue-500', 'bg-slate-800');
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-slate-800');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-slate-800');
                    if (e.dataTransfer.files.length > 0) {
                        bulkFileInput.files = e.dataTransfer.files;
                        handleBulkUpload(e.dataTransfer.files[0]);
                    }
                });
            }

            // Cancel Button
            if (btnCancelBulk) {
                btnCancelBulk.addEventListener('click', () => {
                    bulkFileInput.value = '';
                    validationResult.classList.add('hidden');
                    commitSection.classList.add('hidden');
                    validBulkRecords = [];
                    bulkFileId = null;
                    bulkFilename = null;
                });
            }

            // Re-upload Button
            if (btnReuploadBulk) {
                btnReuploadBulk.addEventListener('click', () => {
                    // Reset UI
                    validationResult.classList.add('hidden');
                    commitSection.classList.add('hidden');
                    validBulkRecords = [];
                    bulkFileId = null;
                    bulkFilename = null;
                    // Trigger file input
                    bulkFileInput.click();
                });
            }

            // Commit Button
            if (btnCommitBulk) {
                btnCommitBulk.addEventListener('click', async () => {
                    if (validBulkRecords.length === 0 || !bulkBatchId) return;
                    
                    // Confirm
                    showConfirm(`Are you sure you want to commit ${validBulkRecords.length} records?`, async () => {
                        try {
                            btnCommitBulk.disabled = true;
                            btnCommitBulk.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Committing...';
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 30000);
                            const response = await fetch(`${API_BASE}/api/extracurricular/upload-commit`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({
                                    batch_id: bulkBatchId,
                                    records: validBulkRecords,
                                    file_id: bulkFileId,
                                    filename: bulkFilename
                                }),
                                signal: controller.signal
                            });
                            clearTimeout(timeoutId);
                            let result;
                            try {
                                result = await response.json();
                            } catch (parseErr) {
                                const text = await response.text();
                                result = { message: text || 'Unexpected response' };
                            }
                            if (response.ok) {
                                const inserted = typeof result.inserted_count === 'number' ? result.inserted_count : (result.count || validBulkRecords.length);
                                showAlert(`File uploaded successfully! Added ${inserted} records.`, 'success');
                                // Reset UI
                                validationResult.classList.add('hidden');
                                commitSection.classList.add('hidden');
                                bulkFileInput.value = '';
                                bulkBatchSelect.value = '';
                                if (bulkOutputTypeSelect) bulkOutputTypeSelect.value = '';
                                bulkFileId = null;
                                bulkFilename = null;
                                // Refresh records
                                if (typeof window.loadExtracurricularRecords === 'function') {
                                    window.loadExtracurricularRecords();
                                }
                            } else {
                                showAlert(`Error: ${result.message}`, 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            showAlert(`Error: ${err.name === 'AbortError' ? 'Request timed out' : err.message}`, 'error');
                        } finally {
                            btnCommitBulk.disabled = false;
                            btnCommitBulk.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i> Commit Valid Records';
                        }
                    });
                });
            }


            // Placement Outcomes Form Handlers
            const outcomeTypeSelect = document.getElementById('outcome-type');
            const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
            const placedFields = document.getElementById('placed-fields');
            const higherStudiesFields = document.getElementById('higher-studies-fields');
            const entrepreneurshipFields = document.getElementById('entrepreneurship-fields');
            const countrySelect = document.getElementById('country');
            const countryNameContainer = document.getElementById('country-name-container');
            const countryNameInput = document.getElementById('country-name');
            const placementForm = document.getElementById('placement-outcome-form');
            const placementSubmitBtn = document.getElementById('placement-submit-btn');
            const placementResetBtn = document.getElementById('placement-reset-btn');

            // Handle outcome type change
            if (outcomeTypeSelect) {
                outcomeTypeSelect.addEventListener('change', (e) => {
                    const outcomeType = e.target.value;
                    
                    // Hide all fields
                    dynamicFieldsContainer.classList.add('hidden');
                    placedFields.classList.add('hidden');
                    higherStudiesFields.classList.add('hidden');
                    entrepreneurshipFields.classList.add('hidden');
                    countryNameContainer.classList.add('hidden');
                    
                    // Show relevant fields
                    if (outcomeType) {
                        dynamicFieldsContainer.classList.remove('hidden');
                        if (outcomeType === 'Placed') {
                            placedFields.classList.remove('hidden');
                        } else if (outcomeType === 'Higher Studies') {
                            higherStudiesFields.classList.remove('hidden');
                        } else if (outcomeType === 'Entrepreneurship') {
                            entrepreneurshipFields.classList.remove('hidden');
                        }
                    }
                });
            }

            // Handle country change for Higher Studies
            if (countrySelect) {
                countrySelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Abroad') {
                        countryNameContainer.classList.remove('hidden');
                        countryNameInput.setAttribute('required', 'required');
                    } else {
                        countryNameContainer.classList.add('hidden');
                        countryNameInput.removeAttribute('required');
                        countryNameInput.value = '';
                    }
                });
            }

            // Handle form submission
            if (placementForm && placementSubmitBtn) {
                placementForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Get batch_id from select element first (get element directly to avoid scope issues)
                    const batchSelect = document.getElementById('placement-batch-select');
                    const batchId = batchSelect ? batchSelect.value : null;
                    if (!batchId) {
                        showAlert('Please select a batch', 'warning');
                        return;
                    }
                    
                    const formData = new FormData(placementForm);
                    
                    // Always set batch_id
                    formData.set('batch_id', batchId);
                    
                    // Basic Validation
                    const numStudents = formData.get('number_of_students');
                    if (numStudents) {
                         const num = parseInt(numStudents);
                         if (isNaN(num) || num < 0) {
                            showAlert('Number of students must be a valid non-negative integer', 'warning');
                            return;
                         }
                    }
                    
                    const yearVal = formData.get('year');
                    if (yearVal) {
                        const year = parseInt(yearVal);
                        if (isNaN(year) || year < 1900 || year > 2100) {
                            showAlert('Year must be a valid 4-digit year', 'warning');
                            return;
                        }
                    }
                    
                    console.log('📤 Submitting placement data (FormData)');
                    
                    const resultDiv = document.getElementById('placement-form-result');
                    const originalText = placementSubmitBtn.innerHTML;
                    
                    try {
                        placementSubmitBtn.disabled = true;
                        placementSubmitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Adding...';
                        resultDiv.classList.add('hidden');
                        
                        const response = await fetch(`${API_BASE}/api/placement-outcomes`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });
                        
                        const result = await response.json();
                        console.log('📥 Response:', response.status, result);
                        resultDiv.classList.remove('hidden');
                        
                        if (response.ok) {
                            resultDiv.innerHTML = `<div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4"><p class="text-green-400 font-semibold"><i class="fa-solid fa-check-circle mr-2"></i>Record added successfully!</p></div>`;
                            placementForm.reset();
                            dynamicFieldsContainer.classList.add('hidden');
                            placedFields.classList.add('hidden');
                            higherStudiesFields.classList.add('hidden');
                            entrepreneurshipFields.classList.add('hidden');
                            countryNameContainer.classList.add('hidden');
                            countryNameInput.removeAttribute('required');
                            outcomeTypeSelect.value = '';
                            
                            // Refresh records list
                            loadPlacementRecords();
                        } else {
                            console.error('❌ API Error:', result);
                            resultDiv.innerHTML = `<div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4"><p class="text-red-400"><i class="fa-solid fa-exclamation-circle mr-2"></i>${result.message || 'Failed to add record'}</p></div>`;
                        }
                    } catch (err) {
                        console.error('❌ Error submitting form:', err);
                        resultDiv.classList.remove('hidden');
                        resultDiv.innerHTML = `<div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4"><p class="text-red-400"><i class="fa-solid fa-exclamation-circle mr-2"></i>Error: ${err.message}</p></div>`;
                    } finally {
                        placementSubmitBtn.disabled = false;
                        placementSubmitBtn.innerHTML = originalText;
                    }
                });
            }

            // Handle form reset
            if (placementResetBtn) {
                placementResetBtn.addEventListener('click', () => {
                    dynamicFieldsContainer.classList.add('hidden');
                    placedFields.classList.add('hidden');
                    higherStudiesFields.classList.add('hidden');
                    entrepreneurshipFields.classList.add('hidden');
                    countryNameContainer.classList.add('hidden');
                    countryNameInput.removeAttribute('required');
                });
            }

            // Load and display placement records (make it accessible globally)
            window.loadPlacementRecords = async function loadPlacementRecords() {
                try {
                    console.log('🔄 Loading placement records...');
                    const recordsBody = document.getElementById('placement-records-body');
                    const countElement = document.getElementById('placement-records-count');
                    
                    if (!recordsBody) {
                        console.error('❌ placement-records-body element not found!');
                        return;
                    }
                    
                    // Show loading state
                    recordsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">Loading records...</td></tr>';
                    
                    const url = `${API_BASE}/api/placement-outcomes?per_page=100`;
                    console.log('📥 Fetching from:', url);
                    
                    const response = await fetch(url, { credentials: 'include' });
                    console.log('📡 Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ API error:', response.status, errorText);
                        recordsBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-400">Error: ${response.status} - ${errorText}</td></tr>`;
                        if (countElement) {
                            countElement.textContent = 'Error';
                        }
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('✅ Received data:', result);
                    console.log('📊 Total records:', result.total || 0);
                    console.log('📋 Records array length:', result.records ? result.records.length : 0);
                    
                    if (countElement) {
                        countElement.textContent = `(${result.total || 0})`;
                    }
                    
                    if (!result.records || result.records.length === 0) {
                        console.log('ℹ️ No records found');
                        recordsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">No records found</td></tr>';
                        return;
                    }
                    
                    console.log('🎨 Rendering', result.records.length, 'records...');
                    
                    // Escape HTML to prevent XSS
                    const escapeHtml = (text) => {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };
                    
                    recordsBody.innerHTML = result.records.map(record => {
                        let details = '';
                        if (record.outcome_type === 'Placed') {
                            details = `${record.company_name || 'N/A'} - ${record.job_role || 'N/A'}`;
                            if (record.ctc_package) details += ` (${record.ctc_package} LPA)`;
                        } else if (record.outcome_type === 'Higher Studies') {
                            details = `${record.degree_type || 'N/A'} in ${record.course_name || 'N/A'}`;
                            details += ` - ${record.university_institute || 'N/A'}`;
                            if (record.country === 'Abroad' && record.country_name) {
                                details += ` (${record.country_name})`;
                            } else if (record.country) {
                                details += ` (${record.country})`;
                            }
                        } else if (record.outcome_type === 'Entrepreneurship') {
                            details = `${record.startup_name || 'N/A'}`;
                            if (record.startup_status) details += ` (${record.startup_status})`;
                        }
                        
                        let namesHtml = '';
                        if (Array.isArray(record.student_names) && record.student_names.length > 0) {
                            const sample = record.student_names.slice(0, 3).map(n => escapeHtml(n)).join(', ');
                            const remaining = record.student_names.length - 3;
                            const display = remaining > 0 ? `${sample} and ${remaining} more` : sample;
                            namesHtml = `<div class="text-xs text-slate-400 mt-1">Students: ${display}</div>`;
                        }
                        
                        return `
                            <tr class="border-b border-slate-700 hover:bg-slate-700/30">
                                <td class="py-3 px-4 text-white">${escapeHtml(record.outcome_type || 'N/A')}</td>
                                <td class="py-3 px-4 text-slate-300">${escapeHtml(details)}${namesHtml}</td>
                                <td class="py-3 px-4 text-right text-white font-semibold">${record.number_of_students || 0}</td>
                                <td class="py-3 px-4 text-slate-300">${escapeHtml(record.year || 'N/A')}</td>
                                <td class="py-3 px-4 text-slate-300 font-medium">${escapeHtml(record.batch_range || 'N/A')}</td>
                                <td class="py-3 px-4 text-center">
                                    <button 
                                        class="delete-outcome-btn px-3 py-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg transition-colors border border-red-500/30"
                                        data-id="${record.id}"
                                        data-details="${escapeHtml(details)}"
                                        title="Delete record"
                                    >
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Attach delete event listeners
                    document.querySelectorAll('.delete-outcome-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const recordId = btn.dataset.id;
                            const details = btn.dataset.details;
                            showConfirm(`Are you sure you want to delete this record?\n\n${details}`, () => {
                                deletePlacementOutcome(recordId);
                            });
                        });
                    });
                } catch (err) {
                    console.error('❌ Error loading placement records:', err);
                    const recordsBody = document.getElementById('placement-records-body');
                    const countElement = document.getElementById('placement-records-count');
                    
                    // Handle network errors (Failed to fetch, ECONNREFUSED, etc.)
                    if (err.message === 'Failed to fetch' || err.name === 'TypeError' || err.message.includes('ECONNREFUSED')) {
                        console.error('🌐 Network error detected');
                        if (recordsBody) {
                            recordsBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">Error loading records: Failed to fetch. Please check your connection.</td></tr>';
                        }
                        if (countElement) {
                            countElement.textContent = 'Error';
                        }
                    } else {
                        // Other errors
                        if (recordsBody) {
                            recordsBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-400">Error loading records: ${err.message || 'Unknown error'}</td></tr>`;
                        }
                        if (countElement) {
                            countElement.textContent = 'Error';
                        }
                    }
                }
            }

            async function deletePlacementOutcome(recordId) {
                try {
                    const response = await fetch(`${API_BASE}/api/placement-outcomes/${recordId}?finalize=false`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    const result = await response.json();
                    if (response.ok) {
                        loadPlacementRecords();
                        showUndoToast('Career Outcomes record', async () => {
                            try {
                                await fetch(`${API_BASE}/api/placement-outcomes/${recordId}?finalize=true`, {
                                    method: 'DELETE',
                                    credentials: 'include',
                                    keepalive: true
                                });
                            } catch (e) {}
                        }, async () => {
                            try {
                                const restoreRes = await fetch(`${API_BASE}/api/placement-outcomes/${recordId}/restore`, {
                                    method: 'POST',
                                    credentials: 'include'
                                });
                                if (restoreRes.ok) {
                                    loadPlacementRecords();
                                }
                            } catch (e) {}
                        });
                    } else {
                        showAlert(`Failed to delete: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (err) {
                    console.error('Error deleting record:', err);
                    showAlert(`Error: ${err.message}`, 'error');
                }
            }

            // Note: Placement records loading is now handled in setupTabs() function
        }

        // Global safety net: finalize all pending deletes on page unload
        window.addEventListener('beforeunload', () => {
            // Use fetch with keepalive to ensure request completes
            fetch(`${API_BASE}/api/finalize-all-pending`, {
                method: 'POST',
                credentials: 'include',
                keepalive: true
            }).catch(e => console.error('Auto-finalize failed:', e));
        });
    </script>

    <!-- Modal for Alerts and Confirmations -->
    <div id="custom-modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] hidden items-center justify-center p-4" style="display: none;">
        <div id="custom-modal-box" class="glass-card rounded-lg shadow-2xl max-w-md w-full p-6 relative z-[10000] bg-slate-800 border border-slate-600 text-center">
            <div id="custom-modal-icon" class="flex justify-center mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-500/20">
                    <i id="custom-modal-icon-class" class="fa-solid fa-triangle-exclamation text-yellow-500 text-xl"></i>
                </div>
            </div>
            <h3 id="custom-modal-title" class="text-lg leading-6 font-semibold text-white mb-2">Confirm Action</h3>
            <p id="custom-modal-message" class="text-sm text-white mb-6 whitespace-pre-line px-7 py-3">Message</p>
            <div id="custom-modal-buttons" class="flex space-x-4 justify-center">
                <!-- Buttons will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-[100]">
        <div class="glass-card rounded-xl shadow-2xl w-full max-w-md p-6 text-center border border-slate-600">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-slate-700 mb-3">
                <i class="fa-solid fa-sign-out-alt text-blue-400 text-xl"></i>
            </div>
            <h3 class="text-white text-lg font-semibold mb-2">Confirm Logout</h3>
            <p class="text-slate-300 mb-5">Are you sure you want to logout?</p>
            <div class="space-x-3">
                <button id="logout-cancel" class="px-5 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600">Cancel</button>
                <button id="logout-confirm" class="px-5 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // Modal utility functions
        function showModal(title, message, type = 'info', buttons = []) {
            const overlay = document.getElementById('custom-modal-overlay');
            const modalBox = document.getElementById('custom-modal-box');
            const modalTitle = document.getElementById('custom-modal-title');
            const modalMessage = document.getElementById('custom-modal-message');
            const modalButtons = document.getElementById('custom-modal-buttons');
            const modalIconContainer = document.getElementById('custom-modal-icon');

            if (!overlay || !modalBox || !modalTitle || !modalMessage || !modalButtons || !modalIconContainer) {
                if (buttons.length === 1 && buttons[0].text === 'OK') {
                    alert(message);
                    if (buttons[0].onClick) buttons[0].onClick();
                } else {
                    alert(message);
                }
                return;
            }

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            let iconClass = 'fa-triangle-exclamation';
            let iconColor = 'text-yellow-500';
            let iconBgColor = 'bg-yellow-500/20';

            if (type === 'error') {
                iconClass = 'fa-xmark';
                iconColor = 'text-red-500';
                iconBgColor = 'bg-red-500/20';
            } else if (type === 'success') {
                iconClass = 'fa-check';
                iconColor = 'text-green-500';
                iconBgColor = 'bg-green-500/20';
            } else if (type === 'warning') {
                iconClass = 'fa-triangle-exclamation';
                iconColor = 'text-yellow-500';
                iconBgColor = 'bg-yellow-500/20';
            } else {
                iconClass = 'fa-circle-info';
                iconColor = 'text-blue-500';
                iconBgColor = 'bg-blue-500/20';
            }

            modalIconContainer.innerHTML = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full ${iconBgColor}"><i class="fa-solid ${iconClass} ${iconColor} text-xl"></i></div>`;

            modalButtons.innerHTML = '';
            let primaryButton = null;
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                if (btn.primary) {
                    button.className = 'inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none';
                    primaryButton = button;
                } else {
                    button.className = 'inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 focus:outline-none';
                }
                button.onclick = () => {
                    overlay.style.display = 'none';
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    if (btn.onClick) btn.onClick();
                };
                modalButtons.appendChild(button);
            });

            overlay.style.display = 'flex';
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            if (window.customModalEnterHandler) {
                document.removeEventListener('keydown', window.customModalEnterHandler, true);
            }

            let lastCustomModalEnterPress = 0;
            window.customModalEnterHandler = (e) => {
                const isVisible = overlay && overlay.style.display === 'flex' && !overlay.classList.contains('hidden');
                if (e.key === 'Enter' && isVisible) {
                    const now = Date.now();
                    if (now - lastCustomModalEnterPress < 500) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                    lastCustomModalEnterPress = now;

                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    if (!primaryButton) {
                        primaryButton = modalButtons.querySelector('button.bg-blue-600, button[class*="bg-blue"]');
                    }

                    if (primaryButton && !primaryButton.disabled) {
                        primaryButton.disabled = true;
                        setTimeout(() => {
                            if (primaryButton) primaryButton.disabled = false;
                        }, 1000);
                        setTimeout(() => {
                            if (primaryButton) primaryButton.click();
                        }, 10);
                    }
                    return false;
                }
            };

            document.addEventListener('keydown', window.customModalEnterHandler, true);
        }
        
        // Close modal when clicking overlay
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('custom-modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.style.display = 'none';
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                    }
                });
            }
        });
        
        function showConfirm(message, onConfirm, onCancel = null) {
            showModal(
                'Confirm Action',
                message,
                'warning',
                [
                    {
                        text: 'Cancel',
                        primary: false,
                        onClick: () => {
                            if (onCancel) onCancel();
                        }
                    },
                    {
                        text: 'Confirm',
                        primary: true,
                        onClick: () => {
                            if (onConfirm) onConfirm();
                        }
                    }
                ]
            );
        }
        
        function showAlert(message, type = 'info') {
            const title = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Information';
            showModal(
                title,
                message,
                type,
                [{ text: 'OK', primary: true, onClick: () => {} }]
            );
        }
        
        let undoToastTimer = null;
        let undoToastActive = false;
        let undoToastFinalize = null;
        function showUndoToast(label, onFinalize, onUndo) {
            if (undoToastActive && undoToastFinalize) {
                try { undoToastFinalize(); } catch(e){}
            }
            try { if (undoToastTimer) { clearInterval(undoToastTimer); undoToastTimer = null; } } catch(e){}
            const existing = document.getElementById('undo-toast');
            if (existing) { existing.remove(); }
            undoToastActive = true;
            undoToastFinalize = onFinalize;
            
            const toast = document.createElement('div');
            toast.id = 'undo-toast';
            toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 z-[10000] bg-slate-700 border border-slate-500 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-4 transition-all duration-300';
            
            const msg = document.createElement('span');
            msg.className = 'font-medium';
            let remaining = 5;
            const itemLabel = label || 'Item';
            msg.textContent = `${itemLabel} deleted. Undo?`;
            
            const btn = document.createElement('button');
            btn.className = 'px-4 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-md text-white text-sm font-semibold transition-colors flex items-center gap-2';
            btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i> Undo (${remaining}s)`;
            
            btn.onclick = async () => {
                try { if (undoToastTimer) { clearInterval(undoToastTimer); undoToastTimer = null; } } catch(e){}
                undoToastActive = false;
                try { await onUndo(); } catch(e){}
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 300);
            };
            
            toast.appendChild(msg);
            toast.appendChild(btn);
            document.body.appendChild(toast);
            
            undoToastTimer = setInterval(async () => {
                remaining -= 1;
                if (remaining <= 0) {
                    try { clearInterval(undoToastTimer); } catch(e){}
                    undoToastTimer = null;
                    toast.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => toast.remove(), 300);
                    undoToastActive = false;
                    try { await onFinalize(); } catch(e){}
                } else {
                    btn.innerHTML = `<i class="fa-solid fa-rotate-left"></i> Undo (${remaining}s)`;
                }
            }, 1000);
            
            window.addEventListener('beforeunload', () => {
            if (undoToastActive && undoToastFinalize) {
                try { onFinalize(); } catch(e){}
            }
        }, { once: true });
    }

    // Global safety net: finalize all pending deletes on page unload
    window.addEventListener('beforeunload', () => {
        // Use fetch with keepalive to ensure request completes
        fetch(`${API_BASE}/api/finalize-all-pending`, {
            method: 'POST',
            credentials: 'include',
            keepalive: true
        }).catch(e => console.error('Auto-finalize failed:', e));
    });
    </script>

    <script>
        (function() {
            const toggleBtn = document.getElementById('sidebar-toggle');
            const appShell = document.getElementById('app-shell');
            const backdrop = document.getElementById('sidebar-backdrop');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    appShell.classList.toggle('mobile-sidebar-open');
                });
            }
            if (backdrop) {
                backdrop.addEventListener('click', () => {
                    appShell.classList.remove('mobile-sidebar-open');
                });
            }
        })();
    </script>
    <div class="aspd-watermark">ASPD | Developed by AIML Students | Internal Pilot Release sv1</div>
</body>
</html>
